<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SRAV â€“ Constructeur de SÃ©ance v5</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;0,900;1,700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --blue:   #0055a4;
  --blue2:  #003f80;
  --yellow: #f5c800;
  --red:    #d62b2b;
  --green:  #1a8a4a;
  --orange: #e07b00;
  --slate:  #1c2b3a;
  --ink:    #2d3a47;
  --mist:   #f2f5f8;
  --line:   #dde3ea;
  --white:  #ffffff;
  --b0:     #7b5ea7;
  --b0bg:   #f3effe;
  --b1:     #d62b2b;
  --b1bg:   #fdecea;
  --b2:     #e07b00;
  --b2bg:   #fef3e2;
  --b3:     #1a8a4a;
  --b3bg:   #e6f4ec;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Lato', sans-serif; background: var(--mist); color: var(--ink); min-height: 100vh; }
.bc { font-family: 'Barlow Condensed', sans-serif; }

/* â”€â”€ HEADER â”€â”€ */
header {
  background: var(--slate); padding: 0 20px;
  display: flex; align-items: center; justify-content: space-between;
  height: 56px; position: sticky; top: 0; z-index: 90;
  box-shadow: 0 2px 12px rgba(0,0,0,.3);
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-dot {
  width: 32px; height: 32px; background: var(--red); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 18px; color: white;
}
.logo-text { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 18px; color: white; text-transform: uppercase; line-height: 1.1; letter-spacing: .03em; }
.logo-text em { color: var(--yellow); font-style: normal; }
.logo-badge { font-size: 9px; font-weight: 700; background: var(--yellow); color: var(--slate); padding: 2px 6px; border-radius: 3px; letter-spacing: .06em; margin-left: 6px; }

/* â”€â”€ STEPPER â”€â”€ */
.stepper { display: flex; align-items: center; background: rgba(255,255,255,.07); border-radius: 6px; overflow: hidden; }
.step-btn { padding: 6px 14px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: .06em; color: rgba(255,255,255,.4); background: transparent; border: none; cursor: pointer; transition: all .2s; border-right: 1px solid rgba(255,255,255,.08); white-space: nowrap; }
.step-btn:last-child { border-right: none; }
.step-btn.done { color: rgba(255,255,255,.6); }
.step-btn.active { background: rgba(255,255,255,.12); color: var(--yellow); }
.step-btn .sn { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; margin-right: 5px; background: rgba(255,255,255,.15); color: white; }
.step-btn.active .sn { background: var(--yellow); color: var(--slate); }
.step-btn.done .sn { background: var(--green); color: white; }

/* â”€â”€ SCREENS â”€â”€ */
.screen { display: none; padding: 20px; max-width: 940px; margin: 0 auto; }
.screen.active { display: block; animation: fadeUp .25s ease; }
@keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

/* â”€â”€ SECTION HEADERS â”€â”€ */
.sh { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 22px; text-transform: uppercase; letter-spacing: .02em; color: var(--slate); margin-bottom: 4px; }
.sub { font-size: 13px; color: #7a8a99; margin-bottom: 20px; }

/* â”€â”€ CARDS â”€â”€ */
.card { background: white; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.07); overflow: hidden; margin-bottom: 16px; }
.card-head { padding: 14px 18px 10px; border-bottom: 1px solid var(--line); display: flex; align-items: center; gap: 10px; }
.card-head-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.card-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; text-transform: uppercase; letter-spacing: .05em; color: var(--slate); }
.card-body { padding: 16px 18px; }

/* â”€â”€ INPUTS â”€â”€ */
.field { margin-bottom: 14px; }
.field:last-child { margin-bottom: 0; }
.label { display: block; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: #8a9aaa; margin-bottom: 5px; }
input[type=text], input[type=number], select, textarea {
  width: 100%; padding: 9px 12px; border: 1.5px solid var(--line); border-radius: 8px;
  font-size: 14px; font-family: 'Lato', sans-serif; color: var(--slate); background: #fafbfc;
  outline: none; transition: border-color .15s; -webkit-appearance: none;
}
input:focus, select:focus, textarea:focus { border-color: var(--blue); background: white; }
.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

/* â”€â”€ BLOC PILLS SELECTOR â”€â”€ */
.bloc-selector { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
.bloc-pill {
  padding: 7px 14px; border-radius: 8px; border: 2px solid var(--line);
  font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 13px;
  cursor: pointer; transition: all .15s; background: white; color: var(--ink);
  display: flex; align-items: center; gap: 6px;
}
.bloc-pill:hover { border-color: #aac0d8; }
.bloc-pill.b0.sel { background: var(--b0bg); border-color: var(--b0); color: var(--b0); }
.bloc-pill.b1.sel { background: var(--b1bg); border-color: var(--b1); color: var(--b1); }
.bloc-pill.b2.sel { background: var(--b2bg); border-color: var(--b2); color: var(--b2); }
.bloc-pill.b3.sel { background: var(--b3bg); border-color: var(--b3); color: var(--b3); }
.bloc-dot { width: 8px; height: 8px; border-radius: 50%; }

/* â”€â”€ NIVEAU PILLS â”€â”€ */
.niv-selector { display: flex; gap: 6px; flex-wrap: wrap; }
.niv-pill {
  padding: 5px 12px; border-radius: 20px; border: 1.5px solid var(--line);
  font-size: 12px; font-weight: 700; cursor: pointer; transition: all .15s;
  background: var(--mist); color: var(--ink);
}
.niv-pill:hover { border-color: #aac0d8; }
.niv-pill.sel { background: var(--blue); border-color: var(--blue); color: white; }

/* â”€â”€ GROUPE BUILDER â”€â”€ */
.grp-row { display: grid; grid-template-columns: 110px 1fr 75px 32px; gap: 8px; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--line); }
.grp-row:first-child { border-top: 1px solid var(--line); }
.grp-label { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 6px; }
.grp-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.grp-effectif { font-size: 13px; color: #7a8a99; text-align: center; }
.btn-ghost { width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--line); background: var(--mist); color: #cc4444; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .15s; }
.btn-ghost:hover { background: #fee; border-color: #cc4444; }

/* â”€â”€ BLOC TAGS â”€â”€ */
.bloc-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 11px; text-transform: uppercase; }
.bloc-tag.b0 { background: var(--b0bg); color: var(--b0); }
.bloc-tag.b1 { background: var(--b1bg); color: var(--b1); }
.bloc-tag.b2 { background: var(--b2bg); color: var(--b2); }
.bloc-tag.b3 { background: var(--b3bg); color: var(--b3); }

/* â”€â”€ FILTERS BAR (Ã©tape 2) â”€â”€ */
.filters-bar {
  background: white; border-radius: 10px; padding: 14px 18px;
  border: 1px solid var(--line); margin-bottom: 14px;
  display: flex; gap: 14px; flex-wrap: wrap; align-items: flex-start;
}
.filters-bar .filter-group { flex: 1; min-width: 200px; }
.filters-bar .filter-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: #8a9aaa; margin-bottom: 7px; }

/* â”€â”€ SITUATION CARDS â”€â”€ */
.sit-grid { display: flex; flex-direction: column; gap: 8px; }
.sit-card { border: 1.5px solid var(--line); border-radius: 10px; padding: 12px 14px; cursor: pointer; transition: all .15s; position: relative; }
.sit-card:hover { border-color: #aac0d8; background: #fafcff; }
.sit-card.selected { border-color: var(--blue); background: #f0f6ff; box-shadow: 0 0 0 3px rgba(0,85,164,.1); }
.sit-card-top { display: flex; align-items: flex-start; gap: 10px; }
.sit-check { width: 20px; height: 20px; border-radius: 5px; border: 2px solid var(--line); flex-shrink: 0; margin-top: 1px; background: white; transition: all .15s; display: flex; align-items: center; justify-content: center; }
.sit-card.selected .sit-check { background: var(--blue); border-color: var(--blue); color: white; font-size: 11px; }
.sit-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; color: var(--slate); line-height: 1.2; }
.sit-comp { font-size: 11px; color: #5a7a9a; margin-top: 2px; font-style: italic; }
.sit-badges { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; }
.sit-niv-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 3px; text-transform: uppercase; letter-spacing: .04em; background: #f0f0f0; color: #555; }
.sit-niv-badge.niv-1 { background: #fff3cd; color: #7a5c00; }
.sit-niv-badge.niv-2 { background: #d1ecf1; color: #0c5460; }
.sit-niv-badge.niv-3 { background: #d4edda; color: #155724; }
.sit-spiral { font-size: 9px; background: #f3eaff; color: #7b5ea7; padding: 2px 6px; border-radius: 3px; font-weight: 700; }
.sit-detail { font-size: 12px; color: #6a7a88; margin-top: 6px; line-height: 1.5; padding-left: 30px; display: none; }
.sit-card.selected .sit-detail { display: block; }
.sit-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
.sit-tag { font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 3px; text-transform: uppercase; letter-spacing: .04em; }
.tag-obj { background: #e8f0fe; color: #1a56cc; }
.tag-crit { background: #e6f4ec; color: #1a6e3c; }

/* â”€â”€ GROUPE SECTION (Ã©tape 2) â”€â”€ */
.grp-section { border-radius: 10px; overflow: hidden; margin-bottom: 16px; border: 1px solid var(--line); }
.grp-section-head { padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
.grp-section-head .grp-num { width: 28px; height: 28px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 16px; color: white; flex-shrink: 0; }
.grp-section-head .info { flex: 1; }
.grp-section-head .gsh-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; color: var(--slate); }
.grp-section-head .gsh-sub { font-size: 11px; color: #8a9aaa; margin-top: 1px; }
.grp-section-body { padding: 14px 16px; background: white; }

/* â”€â”€ BLOC3 ALERT â”€â”€ */
.bloc3-notice {
  background: #e6f4ec; border-left: 4px solid var(--green);
  padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 14px;
  font-size: 12px; color: #1a3a2a;
}
.bloc3-notice strong { display: block; font-size: 13px; margin-bottom: 4px; color: var(--green); }

/* â”€â”€ COMP PILLS â”€â”€ */
.comp-section { margin-bottom: 14px; }
.comp-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: #8a9aaa; margin-bottom: 8px; }
.comp-pills { display: flex; flex-wrap: wrap; gap: 6px; }
.comp-pill { padding: 5px 11px; border-radius: 20px; border: 1.5px solid var(--line); background: var(--mist); font-size: 12px; font-weight: 700; cursor: pointer; transition: all .15s; color: var(--ink); display: inline-flex; align-items: center; gap: 5px; }
.comp-pill:hover { border-color: #aac0d8; background: #f0f6ff; }
/* SÃ©lection manuelle = bleu plein */
.comp-pill.sel-manual { border-color: var(--blue); background: var(--blue); color: white; }
/* SÃ©lection auto (dÃ©duite des situations) = contour bleu, fond clair */
.comp-pill.sel-auto { border-color: var(--blue); background: #e8f0fb; color: var(--blue); }
/* Les deux (auto + confirmÃ© manuellement) = bleu plein + badge âœ“ */
.comp-pill.sel-both { border-color: var(--blue2); background: var(--blue); color: white; }
.comp-pill-niv { font-size: 9px; opacity: .7; }
.comp-pill-badge { font-size: 9px; padding: 1px 5px; border-radius: 3px; font-weight: 700; line-height: 1.4; }
.badge-auto { background: rgba(255,255,255,.25); color: inherit; }
.badge-auto-blue { background: rgba(0,85,164,.15); color: var(--blue); }
.badge-manual { background: rgba(255,255,255,.3); color: white; }

/* â”€â”€ BILAN D'Ã‰VALUATION â”€â”€ */
.bilan-section { margin-top: 16px; border-top: 1px solid var(--line); padding-top: 14px; }
.bilan-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: #8a9aaa; margin-bottom: 10px; }
.bilan-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
.bilan-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 6px 10px; border-radius: 6px; background: var(--mist); }
.bilan-comp-name { font-size: 12px; color: var(--slate); }
.bilan-btns { display: flex; gap: 4px; }
.bilan-btn { padding: 4px 8px; border-radius: 4px; border: 1.5px solid var(--line); background: white; font-size: 10px; font-weight: 700; cursor: pointer; transition: all .12s; color: #666; white-space: nowrap; }
.bilan-btn:hover { border-color: #aac0d8; }
.bilan-btn.sel-ok { background: #d4edda; border-color: #1a8a4a; color: #1a5c30; }
.bilan-btn.sel-prog { background: #fff3cd; border-color: #e07b00; color: #7a4a00; }
.bilan-btn.sel-non { background: #fdecea; border-color: #d62b2b; color: #8a1a1a; }
.bilan-obs textarea { height: 52px; resize: none; font-size: 12px; }

/* â”€â”€ FICHE â”€â”€ */
#screen-fiche { max-width: 1100px; }
.fiche-wrap { background: white; border-radius: 14px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,.1); }
.fiche-banner { background: var(--slate); padding: 20px 28px; display: flex; align-items: flex-start; justify-content: space-between; gap: 20px; }
.fiche-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 28px; color: white; text-transform: uppercase; line-height: 1; }
.fiche-title span { color: var(--yellow); }
.fiche-subtitle { font-size: 13px; color: rgba(255,255,255,.6); margin-top: 4px; }
.fiche-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.fiche-chip { background: rgba(255,255,255,.1); color: rgba(255,255,255,.85); font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 4px; display: flex; align-items: center; gap: 5px; }

.fiche-infos { display: grid; border-bottom: 2px solid var(--line); }
.fi-cell { padding: 12px 18px; border-right: 1px solid var(--line); }
.fi-cell:last-child { border-right: none; }
.fi-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: #aab; margin-bottom: 3px; }
.fi-val { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; color: var(--slate); }

.fiche-cols { display: grid; border-bottom: 1px solid var(--line); }
.fiche-col { border-right: 1px solid var(--line); display: flex; flex-direction: column; }
.fiche-col:last-child { border-right: none; }
.fiche-col-head { padding: 12px 16px; border-bottom: 1px solid var(--line); display: flex; align-items: center; gap: 10px; }
.fcol-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.fcol-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px; color: var(--slate); }
.fcol-sub { font-size: 10px; color: #8a9aaa; }
.fcol-comp { font-size: 10px; font-style: italic; color: #5a7090; padding: 6px 16px 10px; border-bottom: 1px solid var(--line); background: #fafbfc; }
.fiche-sit { padding: 12px 16px; border-bottom: 1px solid var(--line); }
.fiche-sit:last-child { border-bottom: none; }
.fiche-sit-num { width: 20px; height: 20px; border-radius: 5px; display: inline-flex; align-items: center; justify-content: center; font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 13px; color: white; margin-right: 6px; vertical-align: middle; flex-shrink: 0; }
.fiche-sit-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; color: var(--slate); display: inline; }
.fiche-sit-obj { font-size: 11px; color: #5a7090; margin-top: 4px; line-height: 1.45; }
.fiche-sit-crit { font-size: 10px; color: var(--green); font-weight: 700; margin-top: 4px; }
.fiche-sit-mat { font-size: 10px; color: #8a9aaa; margin-top: 3px; }

/* â”€â”€ FICHE BILAN SECTION â”€â”€ */
.fiche-bilan-section { padding: 18px 24px; border-top: 2px solid var(--line); background: #fafbfc; }
.fiche-bilan-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 16px; text-transform: uppercase; letter-spacing: .04em; color: var(--slate); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
.fiche-bilan-cols { display: grid; gap: 16px; }
.fiche-bilan-grp { background: white; border-radius: 8px; border: 1px solid var(--line); overflow: hidden; }
.fiche-bilan-grp-head { padding: 8px 14px; display: flex; align-items: center; gap: 8px; }
.fiche-bilan-grp-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; color: var(--slate); }
.fiche-bilan-grp-body { padding: 10px 14px; }
.fiche-bilan-comp-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--line); font-size: 11px; }
.fiche-bilan-comp-row:last-child { border-bottom: none; }
.fiche-bilan-scale { display: flex; gap: 0; }
.fbs-item { padding: 3px 8px; border: 1px solid #ddd; font-size: 10px; font-weight: 700; }
.fbs-item:first-child { border-radius: 4px 0 0 4px; }
.fbs-item:last-child { border-radius: 0 4px 4px 0; }
.fbs-ok { background: #d4edda; color: #1a5c30; border-color: #a3d4b0; }
.fbs-prog { background: #fff3cd; color: #7a4a00; border-color: #f0d080; }
.fbs-non { background: #fdecea; color: #8a1a1a; border-color: #f5c0bc; }
.fiche-bilan-obs { margin-top: 10px; }
.fiche-bilan-obs-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: #8a9aaa; margin-bottom: 4px; }
.fiche-bilan-obs-box { border: 1px solid var(--line); border-radius: 6px; min-height: 44px; padding: 6px 10px; font-size: 11px; color: #aab; font-style: italic; }

.fiche-mat-bar { padding: 14px 20px; background: #f7f9fb; border-top: 2px solid var(--line); display: flex; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
.mat-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: #8a9aaa; flex: 0 0 100%; }
.mat-chip { background: white; border: 1px solid var(--line); font-size: 11px; font-weight: 700; color: var(--ink); padding: 4px 10px; border-radius: 4px; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn { padding: 11px 22px; border-radius: 9px; border: none; cursor: pointer; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; text-transform: uppercase; letter-spacing: .06em; transition: all .15s; display: inline-flex; align-items: center; gap: 8px; }
.btn-primary { background: var(--blue); color: white; }
.btn-primary:hover { background: var(--blue2); }
.btn-outline { background: white; color: var(--blue); border: 2px solid var(--blue); }
.btn-outline:hover { background: var(--blue); color: white; }
.btn-sm { padding: 7px 14px; font-size: 12px; }
.btn-danger { background: #fdecea; color: var(--red); border: 1px solid #f5c0bc; }
.btn-danger:hover { background: var(--red); color: white; }
.btn-print { background: var(--slate); color: white; }
.btn-print:hover { background: #263545; }

.toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; justify-content: space-between; }

/* â”€â”€ ALERTS â”€â”€ */
.alert { padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; display: flex; align-items: flex-start; gap: 8px; margin-bottom: 14px; }
.alert-info { background: #e8f3ff; color: #1a4a8a; border-left: 3px solid var(--blue); }
.alert-warn { background: #fff8e6; color: #7a5c00; border-left: 3px solid var(--yellow); }
.alert-green { background: #e6f4ec; color: #1a4a2a; border-left: 3px solid var(--green); }

/* â”€â”€ PRINT â”€â”€ */
@media print {
  header, .toolbar, .no-print { display: none !important; }
  body { background: white; }
  .screen { padding: 0; max-width: 100%; }
  .fiche-wrap { box-shadow: none; border-radius: 0; }
  .fiche-cols { page-break-inside: avoid; }
  .fiche-bilan-obs-box { min-height: 60px; }
}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (max-width: 640px) {
  .stepper .step-label { display: none; }
  .row2, .row3 { grid-template-columns: 1fr; }
  .fiche-infos { grid-template-columns: 1fr 1fr !important; }
  .fiche-cols { grid-template-columns: 1fr !important; }
  .fiche-col { border-right: none; border-bottom: 2px solid var(--slate); }
  .grp-row { grid-template-columns: 100px 1fr 65px 30px; gap: 6px; }
  .filters-bar { flex-direction: column; }
}
.empty { text-align: center; padding: 32px 20px; color: #aab; }
.empty-icon { font-size: 36px; margin-bottom: 10px; }
.empty-text { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; }

/* â”€â”€ SUIVI CYCLE â”€â”€ */
#screen-suivi { max-width: 1100px; }
.cycle-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:16px; }
.seance-history { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
.seance-card { background:white; border-radius:10px; border:1px solid var(--line); overflow:hidden; }
.seance-card-head { padding:12px 18px; display:flex; align-items:center; gap:12px; cursor:pointer; user-select:none; }
.seance-card-head:hover { background:#fafcff; }
.seance-num { width:36px; height:36px; border-radius:8px; background:var(--slate); color:white; display:flex; align-items:center; justify-content:center; font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:18px; flex-shrink:0; }
.seance-meta { flex:1; }
.seance-meta-title { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:16px; color:var(--slate); }
.seance-meta-sub { font-size:11px; color:#7a8a99; margin-top:2px; }
.seance-expand { font-size:11px; color:#8a9aaa; }
.seance-card-body { padding:14px 18px; border-top:1px solid var(--line); background:#fafbfc; display:none; }
.seance-card-body.open { display:block; }
.prog-table { width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
.prog-table th { text-align:left; padding:6px 10px; background:var(--slate); color:white; font-family:'Barlow Condensed',sans-serif; font-size:12px; font-weight:700; }
.prog-table td { padding:6px 10px; border-bottom:1px solid var(--line); vertical-align:middle; }
.prog-table tr:last-child td { border-bottom:none; }
.prog-dot { display:inline-flex; align-items:center; gap:4px; padding:2px 7px; border-radius:3px; font-size:10px; font-weight:700; }
.prog-ok  { background:#d4edda; color:#1a5c30; }
.prog-en  { background:#fff3cd; color:#7a4a00; }
.prog-non { background:#fdecea; color:#8a1a1a; }
.prog-nd  { background:#f0f0f0; color:#888; }

/* progression summary par compÃ©tence sur tout le cycle */
.cycle-summary { background:white; border-radius:10px; border:1px solid var(--line); overflow:hidden; margin-bottom:16px; }
.cycle-summary-head { padding:14px 18px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; }
.cycle-comp-row { display:grid; grid-template-columns:200px 1fr; gap:0; border-bottom:1px solid var(--line); min-height:36px; }
.cycle-comp-row:last-child { border-bottom:none; }
.cycle-comp-label { padding:8px 14px; font-size:12px; font-weight:700; color:var(--slate); border-right:1px solid var(--line); display:flex; align-items:center; }
.cycle-comp-dots { padding:8px 14px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.cycle-dot { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:700; color:white; cursor:default; flex-shrink:0; }
.cycle-dot.ok  { background:#1a8a4a; }
.cycle-dot.en  { background:#e07b00; }
.cycle-dot.non { background:#d62b2b; }
.cycle-dot.nd  { background:#c0cdd8; }

/* â”€â”€ QUESTIONNAIRE Ã‰LÃˆVE â”€â”€ */
#screen-questionnaire { max-width: 800px; }
.qst-controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
.qst-preview { background:white; border-radius:12px; border:1px solid var(--line); overflow:hidden; }
.qst-header { background:var(--slate); padding:16px 20px; color:white; display:flex; justify-content:space-between; align-items:flex-start; }
.qst-title { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:22px; text-transform:uppercase; }
.qst-subtitle { font-size:11px; color:rgba(255,255,255,.6); margin-top:3px; }
.qst-prenom { border:none; border-bottom:2px solid rgba(255,255,255,.4); background:transparent; color:white; font-size:14px; font-family:'Lato',sans-serif; padding:4px 0; width:200px; }
.qst-prenom::placeholder { color:rgba(255,255,255,.4); }
.qst-famille { padding:0; }
.qst-famille-head { padding:10px 18px; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:14px; color:white; text-transform:uppercase; letter-spacing:.04em; }
.qst-item { display:grid; grid-template-columns:1fr 60px 60px 70px; padding:8px 18px; border-bottom:1px solid var(--line); font-size:13px; align-items:center; gap:8px; }
.qst-item:last-child { border-bottom:none; }
.qst-item-label { line-height:1.35; }
.qst-check-cell { text-align:center; font-size:10px; font-weight:700; color:#8a9aaa; }
.qst-box { width:24px; height:24px; border:2px solid var(--line); border-radius:4px; margin:0 auto; }
.qst-col-header { display:grid; grid-template-columns:1fr 60px 60px 70px; padding:6px 18px; background:#f7f9fb; border-bottom:2px solid var(--line); gap:8px; }
.qst-col-label { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#8a9aaa; text-align:center; }
.qst-col-label:first-child { text-align:left; }

/* â”€â”€ TOAST â”€â”€ */
.toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--slate); color:white; padding:10px 20px; border-radius:8px; font-size:13px; font-weight:700; z-index:999; transition:transform .3s ease; pointer-events:none; white-space:nowrap; }
.toast.show { transform:translateX(-50%) translateY(0); }

/* â”€â”€ IMPORT ZONE â”€â”€ */
.import-zone { border:2px dashed var(--line); border-radius:10px; padding:24px; text-align:center; cursor:pointer; transition:all .15s; background:white; }
.import-zone:hover, .import-zone.drag { border-color:var(--blue); background:#f0f6ff; }
.import-zone p { font-size:13px; color:#8a9aaa; margin-top:6px; }

/* â”€â”€ MODE IMPRESSION FICHE â”€â”€ */
@media print {
  header, .toolbar, .no-print { display:none !important; }
  body { background:white; }
  .screen { padding:0; max-width:100%; }
  .fiche-wrap { box-shadow:none; border-radius:0; }
  /* Par dÃ©faut : on imprime la fiche, on masque le reste */
  #screen-1, #screen-2, #screen-suivi, #screen-questionnaire { display:none !important; }
  #screen-fiche { display:block !important; }
}

/* â”€â”€ MODE IMPRESSION QUESTIONNAIRE â”€â”€ */
/* On ajoute la classe .print-qst sur <body> avant d'appeler window.print() */
body.print-qst #screen-fiche    { display:none !important; }
body.print-qst #screen-suivi    { display:none !important; }
body.print-qst #screen-1        { display:none !important; }
body.print-qst #screen-2        { display:none !important; }

@media print {
  body.print-qst #screen-questionnaire {
    display:block !important;
    padding:0; max-width:100%;
  }
  body.print-qst #screen-fiche { display:none !important; }
  body.print-qst .qst-controls { display:none !important; }
  body.print-qst .qst-preview  { box-shadow:none; border-radius:0; border:none; }
}

/* â”€â”€ AUTOSAVE INDICATOR â”€â”€ */
.autosave-bar {
  position:fixed; bottom:0; left:0; right:0;
  background:rgba(28,43,58,.92); color:rgba(255,255,255,.7);
  font-size:11px; font-weight:700; padding:5px 16px;
  display:flex; align-items:center; justify-content:space-between;
  z-index:80; backdrop-filter:blur(4px);
  transition:opacity .3s;
}
.autosave-bar.hidden { opacity:0; pointer-events:none; }
.autosave-dot { width:7px; height:7px; border-radius:50%; background:#1a8a4a; margin-right:6px; display:inline-block; }
.autosave-dot.saving { background:var(--yellow); animation:pulse .6s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

/* â”€â”€ BANNIÃˆRE REPRISE SESSION â”€â”€ */
.session-banner {
  background:#fff8e6; border:2px solid var(--yellow);
  border-radius:10px; padding:14px 18px;
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; flex-wrap:wrap; margin-bottom:16px;
}
.session-banner-text { font-size:13px; color:#5a4a00; flex:1; }
.session-banner-text strong { display:block; font-size:14px; margin-bottom:2px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot">ğŸš²</div>
    <div class="logo-text">Savoir Rouler <em>Ã  VÃ©lo</em><br><span style="font-size:11px;font-weight:400;color:rgba(255,255,255,.5);letter-spacing:.12em">CONSTRUCTEUR DE SÃ‰ANCE</span></div>
    <span class="logo-badge">v7</span>
  </div>
  <div class="stepper">
    <button class="step-btn active" id="sbtn-1" onclick="goStep(1)"><span class="sn">1</span><span class="step-label">Classe</span></button>
    <button class="step-btn" id="sbtn-2" onclick="goStep(2)"><span class="sn">2</span><span class="step-label">Situations</span></button>
    <button class="step-btn" id="sbtn-3" onclick="goStep(3)"><span class="sn">3</span><span class="step-label">Fiche</span></button>
    <button class="step-btn" id="sbtn-4" onclick="goStep(4)"><span class="sn">4</span><span class="step-label">Suivi</span></button>
    <button class="step-btn" id="sbtn-5" onclick="goStep(5)"><span class="sn">5</span><span class="step-label">Ã‰lÃ¨ves</span></button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â• Ã‰TAPE 1 : PHOTO DE CLASSE â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-1">
  <div class="sh bc">Ã‰tape 1 â€” Photo de classe</div>
  <div class="sub">DÃ©crivez votre classe et constituez vos groupes. En Bloc 3, la classe sort entiÃ¨re â€” pas de groupes sÃ©parÃ©s.</div>

  <div class="card">
    <div class="card-head">
      <div class="card-head-icon" style="background:#eef3fb">ğŸ“‹</div>
      <span class="card-title">Informations de la sÃ©quence</span>
    </div>
    <div class="card-body">
      <div class="row2">
        <div class="field">
          <label class="label">Ã‰cole / Ã‰tablissement</label>
          <input type="text" id="f-ecole" placeholder="Ex : Ã‰cole Jean Moulin" />
        </div>
        <div class="field">
          <label class="label">Classe</label>
          <input type="text" id="f-classe" placeholder="Ex : CE2 â€“ 24 Ã©lÃ¨ves" />
        </div>
      </div>
      <div class="row3">
        <div class="field">
          <label class="label">Effectif total</label>
          <input type="number" id="f-effectif" value="24" min="1" max="60" />
        </div>
        <div class="field">
          <label class="label">NÂ° de sÃ©ance</label>
          <input type="number" id="f-seance-num" value="1" min="1" max="20" />
        </div>
        <div class="field">
          <label class="label">Sur (total sÃ©ances)</label>
          <input type="number" id="f-seance-total" value="10" min="1" max="30" />
        </div>
      </div>
      <div class="field">
        <label class="label">Lieu</label>
        <input type="text" id="f-lieu" placeholder="Ex : Cour de rÃ©crÃ©ation, espace cyclable Naudinâ€¦" />
      </div>
    </div>
  </div>

  <!-- Groupes -->
  <div class="card">
    <div class="card-head">
      <div class="card-head-icon" style="background:#eef3fb">ğŸ‘¥</div>
      <span class="card-title">Constitution des groupes</span>
      <button class="btn btn-outline btn-sm no-print" style="margin-left:auto" onclick="addGroupe()">+ Ajouter un groupe</button>
    </div>
    <div class="card-body" style="padding-bottom:8px">
      <div class="alert alert-info">
        Commencez par l'Ã©valuation diagnostique (sÃ©ance 1) pour observer le niveau de chaque Ã©lÃ¨ve. En <strong>Bloc 3</strong>, tous les Ã©lÃ¨ves participent ensemble â€” un seul groupe sera gÃ©nÃ©rÃ©.
      </div>
      <div id="groupes-list"></div>
      <div id="effectif-check" style="font-size:12px;margin-top:10px;font-weight:700"></div>
    </div>
  </div>

  <div style="display:flex;justify-content:flex-end">
    <button class="btn btn-primary" onclick="goStep(2)">Choisir les situations â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• Ã‰TAPE 2 : SITUATIONS â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-2">
  <div class="sh bc">Ã‰tape 2 â€” Situations pÃ©dagogiques</div>
  <div class="sub">Pour chaque groupe, filtrez les situations puis sÃ©lectionnez vos activitÃ©s. Cochez les compÃ©tences visÃ©es et Ã©valuez les progrÃ¨s aprÃ¨s la sÃ©ance.</div>
  <div id="groupes-sit-sections"></div>
  <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <button class="btn btn-outline" onclick="goStep(1)">â† Modifier la classe</button>
    <button class="btn btn-primary" onclick="generateFiche()">GÃ©nÃ©rer la fiche de sÃ©ance â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• Ã‰TAPE 4 : SUIVI DU CYCLE â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-suivi">
  <div class="cycle-header">
    <div>
      <div class="sh bc">Ã‰tape 4 â€” Suivi du cycle</div>
      <div class="sub" style="margin-bottom:0">Remplissez le bilan, puis sauvegardez. Rechargez votre fichier Ã  chaque nouvelle sÃ©ance.</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn btn-outline btn-sm" id="btn-charger-cycle" onclick="document.getElementById('file-import-input').click()">
        ğŸ“‚ Charger un cycle existant
      </button>
      <input type="file" id="file-import-input" accept=".json" style="display:none" onchange="importCycle(this)">
      <button class="btn btn-primary btn-sm" onclick="exporterCycle()">ğŸ’¾ Sauvegarder &amp; exporter (.json)</button>
      <button class="btn btn-sm" onclick="confirmerReinit()" style="background:#fdecea;color:var(--red);border:1px solid #f5c0bc">ğŸ—‘ RÃ©initialiser</button>
    </div>
  </div>

  <!-- Flux de travail -->
  <div class="alert alert-info no-print" style="margin-bottom:16px">
    <div>
      <strong>Flux de travail :</strong>
      <span style="font-weight:400"> (1) ComplÃ©tez le bilan ci-dessous aprÃ¨s la sÃ©ance â†’ (2) Cliquez "Sauvegarder &amp; exporter" â†’ un fichier .json se tÃ©lÃ©charge â†’ (3) Ã€ la prochaine sÃ©ance, rechargez ce fichier avec "Charger un cycle existant" pour retrouver l'historique complet.</span>
    </div>
  </div>

  <!-- Zone drag-drop import -->
  <div id="import-dropzone" class="import-zone" style="margin-bottom:16px;display:none"
    ondragover="event.preventDefault();this.classList.add('drag')"
    ondragleave="this.classList.remove('drag')"
    ondrop="handleDrop(event)">
    <div style="font-size:28px">ğŸ“‚</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:16px;color:var(--slate);margin-top:6px">Glissez votre fichier .json ici</div>
    <p>ou cliquez sur "Charger un cycle existant" ci-dessus</p>
  </div>

  <!-- BILAN DE LA SÃ‰ANCE EN COURS -->
  <div class="card" style="margin-bottom:16px">
    <div class="card-head">
      <div class="card-head-icon" style="background:#fff3cd">ğŸ“</div>
      <span class="card-title">Bilan de la sÃ©ance en cours</span>
      <span style="margin-left:auto;font-size:11px;color:#e07b00;font-weight:700">Ã€ remplir aprÃ¨s la sÃ©ance Â· avant de sauvegarder</span>
    </div>
    <div class="card-body" style="padding:0">
      <div id="bilan-rapide-list"></div>
    </div>
  </div>

  <!-- SynthÃ¨se progression -->
  <div id="cycle-summary-wrap"></div>

  <!-- Historique sÃ©ances -->
  <div class="card">
    <div class="card-head">
      <div class="card-head-icon" style="background:#eef3fb">ğŸ“…</div>
      <span class="card-title">Historique des sÃ©ances sauvegardÃ©es</span>
      <span id="cycle-count" style="margin-left:auto;font-size:12px;color:#8a9aaa"></span>
    </div>
    <div class="card-body" style="padding:0">
      <div id="seance-history-list">
        <div class="empty" style="padding:24px">
          <div class="empty-icon">ğŸ“­</div>
          <div class="empty-text">Aucune sÃ©ance sauvegardÃ©e</div>
          <p style="font-size:12px;color:#aab;margin-top:6px">Remplissez le bilan ci-dessus et cliquez "Sauvegarder &amp; exporter"</p>
        </div>
      </div>
    </div>
  </div>

  <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <button class="btn btn-outline" onclick="goStep(3)">â† Retour Ã  la fiche</button>
    <button class="btn btn-primary" onclick="goStep(5)">Questionnaire Ã©lÃ¨ves â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• Ã‰TAPE 5 : QUESTIONNAIRE Ã‰LÃˆVE â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-questionnaire">
  <div class="sh bc">Ã‰tape 5 â€” Questionnaire d'auto-Ã©valuation</div>
  <div class="sub">Fiche Ã©lÃ¨ve Ã  imprimer, filtrÃ©e sur les compÃ©tences travaillÃ©es dans ce cycle.</div>

  <div class="qst-controls no-print">
    <div style="font-size:12px;color:#7a8a99;flex:1">Les items en grisÃ© n'ont pas encore Ã©tÃ© travaillÃ©s. DÃ©cochez-les pour les masquer Ã  l'impression.</div>
    <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
      <input type="checkbox" id="qst-hide-unused" onchange="renderQuestionnaire()"> Masquer les items non travaillÃ©s
    </label>
    <button class="btn btn-print btn-sm" onclick="printQuestionnaire()">ğŸ–¨ Imprimer les fiches Ã©lÃ¨ves</button>
  </div>

  <div class="qst-preview" id="qst-output"></div>

  <div style="margin-top:16px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <button class="btn btn-outline" onclick="goStep(4)">â† Retour au suivi</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- MODAL CONFIRMATION RÃ‰INITIALISATION -->
<div id="reinit-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center">
  <div style="background:white;border-radius:14px;padding:28px;max-width:400px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,.2)">
    <div style="font-size:28px;text-align:center;margin-bottom:12px">âš ï¸</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:var(--slate);text-align:center;margin-bottom:8px">RÃ©initialiser l'outil ?</div>
    <p style="font-size:13px;color:#5a7090;text-align:center;margin-bottom:6px">Cette action supprime :</p>
    <ul style="font-size:12px;color:#5a7090;margin:0 0 16px 20px;line-height:1.8">
      <li>La session en cours (groupes, situations, bilans)</li>
      <li>L'historique du cycle en mÃ©moire</li>
      <li>La sauvegarde automatique du navigateur</li>
    </ul>
    <p style="font-size:12px;font-weight:700;color:var(--red);text-align:center;margin-bottom:20px">âš  Exportez d'abord votre cycle (.json) si vous souhaitez le conserver.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="fermerReinit()">Annuler</button>
      <button class="btn" style="background:var(--red);color:white" onclick="reinitialiser()">Oui, tout effacer</button>
    </div>
  </div>
</div>

<!-- BANNIÃˆRE REPRISE SESSION -->
<div class="session-banner" id="session-banner" style="display:none;margin:12px 20px 0">
  <div class="session-banner-text">
    <strong>ğŸ’¾ Session prÃ©cÃ©dente trouvÃ©e</strong>
    Une sauvegarde automatique existe â€” vous pouvez reprendre exactement lÃ  oÃ¹ vous en Ã©tiez.
  </div>
  <div style="display:flex;gap:8px;flex-shrink:0">
    <button class="btn btn-primary btn-sm" onclick="restaurerSession()">â†© Reprendre la session</button>
    <button class="btn btn-outline btn-sm" onclick="ignorerSession()">Ignorer</button>
  </div>
</div>

<!-- BARRE AUTOSAVE -->
<div class="autosave-bar hidden" id="autosave-bar">
  <span><span class="autosave-dot" id="autosave-dot"></span><span id="autosave-msg">Sauvegarde automatique active</span></span>
  <span style="font-size:10px;opacity:.6">Les donnÃ©es sont conservÃ©es si la page se recharge accidentellement</span>
</div>
<div class="screen" id="screen-fiche">
  <div class="toolbar no-print">
    <div>
      <div class="sh bc" style="font-size:18px;margin-bottom:0">Fiche de sÃ©ance</div>
      <div style="font-size:12px;color:#8a9aaa">Imprimez cette fiche Â· Remplissez le bilan aprÃ¨s la sÃ©ance en Ã©tape 4</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-outline btn-sm" onclick="goStep(2)">â† Modifier</button>
      <button class="btn btn-outline btn-sm" onclick="goStep(4)" style="border-color:var(--orange);color:var(--orange)">ğŸ“ Bilan &amp; Suivi</button>
      <button class="btn btn-print btn-sm" onclick="window.print()">ğŸ–¨ Imprimer / PDF</button>
    </div>
  </div>
  <div class="fiche-wrap" id="fiche-output"></div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RÃ‰FÃ‰RENTIEL SRAV â€” 4 BLOCS + NIVEAUX 1/2/3
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BLOCS_META = {
  b0: { label:"Bloc 0 â€“ S'Ã©quilibrer",      shortLabel:"Bloc 0",  color:"#7b5ea7", bg:"#f3effe", icon:"ğŸ§¸", contexte:"Maternelle / Draisienne" },
  b1: { label:"Bloc 1 â€“ Savoir PÃ©daler",    shortLabel:"Bloc 1",  color:"#d62b2b", bg:"#fdecea", icon:"ğŸš²", contexte:"Milieu amÃ©nagÃ© â€” cour d'Ã©cole" },
  b2: { label:"Bloc 2 â€“ Savoir Circuler",   shortLabel:"Bloc 2",  color:"#e07b00", bg:"#fef3e2", icon:"ğŸ”", contexte:"Milieu protÃ©gÃ© â€” circuit balisÃ©" },
  b3: { label:"Bloc 3 â€“ Savoir Rouler",     shortLabel:"Bloc 3",  color:"#1a8a4a", bg:"#e6f4ec", icon:"ğŸ›£ï¸",  contexte:"Voie publique â€” toute la classe", classeEntiere:true },
};

/* CompÃ©tences par bloc, chacune associÃ©e Ã  un niveau 1/2/3
   niv = niveau oÃ¹ elle est principalement visÃ©e (peut Ãªtre travaillÃ©e dans plusieurs blocs)
   spiral = [blocs dans lesquels elle rÃ©apparaÃ®t] */
const COMPETENCES = {
  b0: {
    comps: [
      { id:"b0-eq", label:"Ã‰quipement (casque)", niv:1, detail:"Mettre et rÃ©gler son casque" },
      { id:"b0-eq2", label:"Nommer les Ã©lÃ©ments du vÃ©lo", niv:1, detail:"Nommer : cadre, guidon, freins, pÃ©dales, selle, roues" },
      { id:"b0-mv", label:"S'Ã©quilibrer en mouvement", niv:1, detail:"Pousser, glisser, lever les pieds" },
    ]
  },
  b1: {
    comps: [
      { id:"b1-eq",  label:"Ã‰quipement & vÃ©rification du vÃ©lo",   niv:1, spiral:["b2","b3"], detail:"Mettre le casque, nommer les Ã©lÃ©ments, vÃ©rifier freins et pneus" },
      { id:"b1-fd",  label:"Monter/descendre Â· dÃ©marrer",          niv:1, detail:"Monter et descendre Ã  l'arrÃªt Â· DÃ©marrer pied sur pÃ©dale haute" },
      { id:"b1-ld",  label:"Ligne droite & slalom simple",         niv:1, detail:"Conduire en ligne droite Â· Slalom simple sans poser le pied" },
      { id:"b1-fr",  label:"Freiner dans une zone dÃ©limitÃ©e",      niv:1, spiral:["b2","b3"], detail:"Ralentir, freiner et s'arrÃªter dans une zone dÃ©limitÃ©e" },
      { id:"b1-pan", label:"Panneaux signalÃ©tiques (niveau 1)",    niv:1, spiral:["b2","b3"], detail:"Stop, sens interdit, vÃ©los interdits, piste cyclable, cÃ©dez le passage, sens unique" },
      { id:"b1-ap",  label:"RelÃ¢cher un appui (main ou pied)",     niv:2, detail:"Rouler en enlevant une main ou un pied de l'appui" },
      { id:"b1-ci",  label:"Couloir Ã©troit (30 cm) + prise d'info",niv:2, detail:"Rouler dans un couloir 30 cm / 10 m Â· Prendre des informations en roulant" },
      { id:"b1-vi",  label:"Virage Ã  90Â° & franchissement",        niv:2, detail:"Effectuer un virage Ã  90Â° Â· Franchir un petit obstacle" },
      { id:"b1-vt",  label:"Changement de vitesses",               niv:3, detail:"Changer de vitesse en roulant selon le relief ou un signal" },
    ]
  },
  b2: {
    comps: [
      { id:"b2-eq",  label:"SÃ©curitÃ© vÃ©lo (Ã©clairage, catadioptres, sonnette)", niv:2, spiral:["b3"], detail:"Identifier les Ã©lÃ©ments de sÃ©curitÃ© Â· VÃ©rifier le bon fonctionnement" },
      { id:"b2-pan", label:"Panneaux signalÃ©tiques (niveau 2)",    niv:2, spiral:["b3"], detail:"Feu tricolore, sens giratoire, prioritÃ© Ã  droite, endroit frÃ©quentÃ© par des enfants" },
      { id:"b2-es",  label:"Identifier les espaces cyclables",     niv:2, spiral:["b3"], detail:"ReconnaÃ®tre piste cyclable, bande cyclable, chaussÃ©e" },
      { id:"b2-cr",  label:"Code de la route en milieu protÃ©gÃ©",   niv:2, spiral:["b3"], detail:"Rouler en respectant le code de la route sur circuit balisÃ©" },
      { id:"b2-au",  label:"Tenir compte des autres usagers",      niv:2, spiral:["b3"], detail:"Adapter son dÃ©placement aux autres Ã©lÃ¨ves et piÃ©tons" },
      { id:"b2-co",  label:"Communiquer avec les autres cyclistes",niv:3, spiral:["b3"], detail:"Faire connaÃ®tre sa direction Â· Identifier les changements de direction des autres" },
      { id:"b2-gi",  label:"Giratoire en milieu protÃ©gÃ©",          niv:3, detail:"S'insÃ©rer et circuler sur un rond-point tracÃ© au sol" },
    ]
  },
  b3: {
    comps: [
      { id:"b3-eq",  label:"VÃ©rification complÃ¨te du vÃ©lo",        niv:3, detail:"Potence, serrage des roues, selle, freins â€” vÃ©rification avant la sortie" },
      { id:"b3-pan", label:"Panneaux signalÃ©tiques (niveau 3)",    niv:3, detail:"Tous les panneaux : stop, giratoire, zone piÃ©tonne, prioritÃ© Ã  droite" },
      { id:"b3-es",  label:"Emprunter les espaces cyclables rÃ©els",niv:3, detail:"Piste cyclable, bande cyclable Â· Ne pas rouler sur le trottoir" },
      { id:"b3-cr",  label:"Code de la route en situation rÃ©elle", niv:3, detail:"Circuler en respectant le code de la route sur voie publique" },
      { id:"b3-us",  label:"Tenir compte des usagers rÃ©els",       niv:3, detail:"Voitures, piÃ©tons, autres cyclistes â€” s'adapter en temps rÃ©el" },
      { id:"b3-dr",  label:"Rouler Ã  droite & en file",            niv:3, detail:"Rouler Ã  droite Â· Rouler en file indienne sur la voie publique" },
      { id:"b3-gi",  label:"Giratoires & intersections rÃ©els",     niv:3, detail:"Prendre sa place sur la chaussÃ©e aux giratoires et intersections" },
    ]
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE DE DONNÃ‰ES â€” SITUATIONS PÃ‰DAGOGIQUES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SITUATIONS = [
  // â”€â”€ BLOC 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s00a", bloc:"b0", niv:1, comps:["b0-mv"],
    titre:"Pousse-trottinette libre",
    obj:"Explorer le dÃ©placement sur deux roues en faisant glisser.",
    desc:"Les Ã©lÃ¨ves poussent leur draisienne librement dans l'espace, soulevant les pieds le plus longtemps possible.",
    crit:"Glisser sans toucher le sol pendant au moins 2 secondes.",
    mat:"Draisiennes, espace plat sÃ©curisÃ©", duree:"10 min" },

  { id:"s00b", bloc:"b0", niv:1, comps:["b0-mv"],
    titre:"Le chat et la souris (draisienne)",
    obj:"S'Ã©quilibrer en situation de jeu collectif dynamique.",
    desc:"Un Ã©lÃ¨ve \"chat\" (Ã  pied) tente de toucher les \"souris\" sur draisienne. Les souris glissent sans poser les pieds.",
    crit:"Maintenir l'Ã©quilibre en changeant de direction.", mat:"Draisiennes, espace dÃ©limitÃ©", duree:"12 min" },

  // â”€â”€ BLOC 1 â€” Niveau 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s01", bloc:"b1", niv:1, comps:["b1-fd"],
    titre:"L'escargot",
    obj:"MaÃ®triser l'Ã©quilibre Ã  trÃ¨s faible vitesse, sans poser le pied.",
    desc:"Course de lenteur : le dernier arrivÃ© entre deux plots (10 m) sans poser le pied gagne.",
    crit:"Arriver dernier sans poser le pied au sol.", mat:"Plots, espace plat 10 m", duree:"10 min" },

  { id:"s02", bloc:"b1", niv:1, comps:["b1-fd"],
    titre:"DÃ©marrage arrÃªtÃ© â€“ pÃ©dale haute",
    obj:"DÃ©marrer efficacement avec le pied sur la pÃ©dale haute.",
    desc:"8 dÃ©marrages consÃ©cutifs avec un pied sur la pÃ©dale haute pour une poussÃ©e prolongÃ©e.",
    crit:"8 dÃ©marrages sur 10 sans erreur de pied.", mat:"VÃ©los, ligne de dÃ©part", duree:"10 min" },

  { id:"s03", bloc:"b1", niv:1, comps:["b1-ld"],
    titre:"L'entonnoir",
    obj:"MaÃ®triser sa trajectoire dans un couloir progressivement plus Ã©troit.",
    desc:"Couloir qui se rÃ©trÃ©cit de 2 m Ã  50 cm sur 15 m. Traverser sans toucher les limites.",
    crit:"8 passages sur 10 sans toucher les bords.", mat:"Plots ou ruban, 15 m", duree:"12 min" },

  { id:"s04", bloc:"b1", niv:1, comps:["b1-ld"],
    titre:"Slalom simple",
    obj:"Conduire sur un parcours sinueux sans perdre l'Ã©quilibre.",
    desc:"Contourner 5 plots alignÃ©s sur un parcours sinueux sans poser le pied au sol.",
    crit:"Terminer le slalom sans renverser de plot ni poser le pied.", mat:"5 cÃ´nes, espace 10 m", duree:"10 min" },

  { id:"s05", bloc:"b1", niv:1, comps:["b1-fr"],
    titre:"Le pose-pied",
    obj:"ContrÃ´ler le freinage en posant alternativement le pied choisi.",
    desc:"S'arrÃªter dans un couloir en posant alternativement le pied droit puis gauche selon consigne.",
    crit:"S'arrÃªter sur le pied choisi sans dÃ©sÃ©quilibre.", mat:"Plots, couloir 5 m", duree:"10 min" },

  { id:"s06", bloc:"b1", niv:1, comps:["b1-fr"],
    titre:"1-2-3 Soleil",
    obj:"Immobilisation immÃ©diate au signal â€” contrÃ´le global du freinage.",
    desc:"Les Ã©lÃ¨ves avancent librement ; au signal Â« Soleil ! Â», arrÃªt complet sans poser le pied.",
    crit:"ArrÃªt complet sans mouvement rÃ©siduel au signal.", mat:"Espace ouvert, sifflet", duree:"8 min" },

  { id:"s06b", bloc:"b1", niv:1, comps:["b1-pan"],
    titre:"Jacques a dit (panneaux)",
    obj:"Identifier et rÃ©agir aux principaux panneaux de signalisation.",
    desc:"Un Ã©lÃ¨ve tient un panneau (stop, cÃ©dez le passageâ€¦). L'enseignant dit Â« Jacques a dit [panneau] Â» â€” les cyclistes appliquent la rÃ¨gle.",
    crit:"RÃ©agir correctement Ã  8 panneaux sur 10.", mat:"Panneaux imprimÃ©s ou plastifiÃ©s, espace ouvert", duree:"10 min" },

  // â”€â”€ BLOC 1 â€” Niveau 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s07", bloc:"b1", niv:2, comps:["b1-ap","b1-ci"],
    titre:"LÃ¢cher le guidon",
    obj:"RelÃ¢cher une main pour signaler un changement de direction.",
    desc:"Sur un parcours balisÃ©, lÃ¢cher une main pour tendre le bras du cÃ´tÃ© souhaitÃ© Ã  chaque virage.",
    crit:"Maintenir l'Ã©quilibre et la trajectoire pendant tout le signal.", mat:"Parcours balisÃ© 15 m", duree:"10 min" },

  { id:"s08", bloc:"b1", niv:2, comps:["b1-ci"],
    titre:"Bande Ã©troite (30 cm)",
    obj:"Rouler dans un espace trÃ¨s contraint sans en sortir.",
    desc:"Rouler sur une bande de 30 cm de large sur 10 m sans toucher les bords.",
    crit:"Traverser sans toucher les bords ni descendre.", mat:"Madrier ou ruban 30 cm Ã— 10 m", duree:"10 min" },

  { id:"s09", bloc:"b1", niv:2, comps:["b1-ci"],
    titre:"Prise d'information en roulant",
    obj:"Identifier des signaux tout en maintenant une trajectoire rectiligne.",
    desc:"Rouler dans un couloir droit en tournant la tÃªte pour identifier des signaux ou objets placÃ©s sur les cÃ´tÃ©s.",
    crit:"ReconnaÃ®tre 8 signaux sur 10 sans dÃ©vier.", mat:"Couloir 15 m, cartes colorÃ©es", duree:"12 min" },

  { id:"s10", bloc:"b1", niv:2, comps:["b1-vi"],
    titre:"Virage Ã  90Â°",
    obj:"Effectuer un virage serrÃ© en maintenant l'Ã©quilibre.",
    desc:"Parcours en L : prendre un virage Ã  90Â° en maintenant le regard loin et la pÃ©dale intÃ©rieure en haut.",
    crit:"RÃ©ussir 8 virages sur 10 sans poser le pied.", mat:"Plots, espace 10Ã—10 m", duree:"12 min" },

  { id:"s11", bloc:"b1", niv:2, comps:["b1-vi"],
    titre:"Franchissement d'obstacle",
    obj:"Passer un obstacle (bÃ¢ton ou bord) sans perdre l'Ã©quilibre.",
    desc:"Franchir un bÃ¢ton posÃ© au sol en soulevant lÃ©gÃ¨rement le guidon, puis les deux roues progressivement.",
    crit:"Franchir sans arrÃªter les pÃ©dales ni poser le pied.", mat:"BÃ¢tons, planches lÃ©gÃ¨res", duree:"10 min" },

  // â”€â”€ BLOC 1 â€” Niveau 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s12", bloc:"b1", niv:3, comps:["b1-fr"],
    titre:"Jeu de la latte â€“ freinage prÃ©cis",
    obj:"Freiner prÃ©cisÃ©ment pour que seule la premiÃ¨re barre tombe.",
    desc:"AccÃ©lÃ©rer puis freiner pour toucher la premiÃ¨re barre sans atteindre la seconde.",
    crit:"8 essais sur 10 : seule la premiÃ¨re barre touchÃ©e.", mat:"2 barres souples, plots", duree:"10 min" },

  { id:"s13", bloc:"b1", niv:3, comps:["b1-vt"],
    titre:"Changement de vitesses",
    obj:"Adapter le braquet au relief ou Ã  un signal sonore en roulant.",
    desc:"Parcours avec montÃ©es simulÃ©es : changer de vitesse Ã  chaque changement de relief en maintenant un pÃ©dalage rÃ©gulier.",
    crit:"Cadence de pÃ©dalage rÃ©guliÃ¨re maintenue pendant le changement.", mat:"VÃ©los avec dÃ©railleur, parcours avec relief", duree:"15 min" },

  // â”€â”€ BLOC 2 â€” Niveau 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s14", bloc:"b2", niv:2, comps:["b2-es","b2-cr"],
    titre:"La grande circulation",
    obj:"Rouler en flux continu en respectant les espaces et les rÃ¨gles.",
    desc:"Tous les Ã©lÃ¨ves circulent dans un espace balisÃ© avec panneaux, passages piÃ©tons, stop. Flux continu pendant 5 min.",
    crit:"ZÃ©ro infraction majeure (stop non respectÃ©, mauvaise trajectoire).", mat:"Espace balisÃ©, panneaux, craie", duree:"15 min" },

  { id:"s15", bloc:"b2", niv:2, comps:["b2-cr"],
    titre:"ArrÃªt de prÃ©cision",
    obj:"S'arrÃªter Ã©quilibrÃ© dans une zone trÃ¨s Ã©troite aprÃ¨s accÃ©lÃ©ration.",
    desc:"Zone de freinage = 2,5 Ã— longueur du vÃ©lo. Prendre de la vitesse puis freiner pour s'immobiliser dans la zone.",
    crit:"8 arrÃªts sur 10 dans la zone sans poser le pied hors zone.", mat:"Ruban ou plots, espace 20 m", duree:"12 min" },

  { id:"s15b", bloc:"b2", niv:2, comps:["b2-au"],
    titre:"Regard en arriÃ¨re (sans dÃ©vier)",
    obj:"Tourner la tÃªte en arriÃ¨re pour observer sans dÃ©vier de trajectoire.",
    desc:"Rouler en ligne droite, tourner la tÃªte Ã  gauche au signal pour identifier le nombre de doigts de l'enseignant.",
    crit:"8 rÃ©ponses correctes sur 10 sans dÃ©passer la ligne.", mat:"Couloir 20 m, sifflet", duree:"10 min" },

  // â”€â”€ BLOC 2 â€” Niveau 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s16", bloc:"b2", niv:3, comps:["b2-co"],
    titre:"Changement de direction signalÃ©",
    obj:"Signaler ses changements de direction en lÃ¢chant le guidon.",
    desc:"Sur un parcours avec virages, lÃ¢cher une main et tendre le bras avant chaque virage.",
    crit:"8 changements signalÃ©s correctement en moins de 5 min.", mat:"Parcours balisÃ© 20 m", duree:"12 min" },

  { id:"s17", bloc:"b2", niv:3, comps:["b2-co","b2-au"],
    titre:"Communication en file indienne",
    obj:"Transmettre des informations en file (obstacles, arrÃªts).",
    desc:"File de 4-6 Ã©lÃ¨ves. L'enseignant communique un obstacle au 1er â€” l'info se propage jusqu'au dernier par gestes.",
    crit:"Transmission correcte et fluide jusqu'au dernier.", mat:"Plots obstacles, espace 30 m", duree:"15 min" },

  { id:"s18", bloc:"b2", niv:3, comps:["b2-cr","b2-co","b2-gi"],
    titre:"Le giratoire",
    obj:"S'insÃ©rer et circuler sur un rond-point en signalant sa sortie.",
    desc:"Rond-point tracÃ© au sol (D = 6 m). S'insÃ©rer, tourner 1-2 fois, sortir en signalant de la main gauche.",
    crit:"ManÅ“uvre complÃ¨te sans quitter le tracÃ© ni perdre l'Ã©quilibre.", mat:"Craie ou ruban, plots, espace 8Ã—8 m", duree:"15 min" },

  { id:"s19", bloc:"b2", niv:3, comps:["b2-au"],
    titre:"S'arrÃªter et repartir Ã  plusieurs",
    obj:"Coordonner arrÃªt et dÃ©part en formation collective.",
    desc:"Rouler 2-3 de front, s'arrÃªter ensemble au signal, redÃ©marrer en file indienne.",
    crit:"RedÃ©marrage ordonnÃ© en file sans collision.", mat:"Plots, espace 20 m", duree:"12 min" },

  // â”€â”€ BLOC 3 â€” Voie publique â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:"s20", bloc:"b3", niv:3, comps:["b3-eq","b3-cr"],
    titre:"VÃ©rification avant sortie (\"ContrÃ´le technique\")",
    obj:"VÃ©rifier systÃ©matiquement son vÃ©lo avant de circuler sur voie publique.",
    desc:"Chaque Ã©lÃ¨ve contrÃ´le son vÃ©lo sur checklist : pneus, freins, selle, lumiÃ¨res. En binÃ´me â€” chacun contrÃ´le celui de l'autre.",
    crit:"Checklist complÃ¨te validÃ©e pour 100% des vÃ©los.", mat:"Checklist imprimÃ©e, outils basiques", duree:"10 min" },

  { id:"s21", bloc:"b3", niv:3, comps:["b3-dr","b3-us"],
    titre:"Rouler en file sur voie publique",
    obj:"Maintenir une file indienne ordonnÃ©e en tenant sa droite.",
    desc:"Sortie sur voie publique sÃ©curisÃ©e. Rouler en file, 1 m d'Ã©cart, Ã  droite. Signal d'arrÃªt transmis de l'avant vers l'arriÃ¨re.",
    crit:"File maintenue sur 500 m sans dÃ©bordement ni collision.", mat:"Gilets jaunes, Ã©quipement vÃ©lo, parcours repÃ©rÃ©", duree:"30 min" },

  { id:"s22", bloc:"b3", niv:3, comps:["b3-cr","b3-pan"],
    titre:"Intersections & prioritÃ©s rÃ©elles",
    obj:"Appliquer les rÃ¨gles de prioritÃ© aux intersections sur voie publique.",
    desc:"Sortie incluant 2-3 intersections. Avant chaque intersection, arrÃªt ou ralentissement, regard Ã  gauche et droite, application de la rÃ¨gle.",
    crit:"ZÃ©ro infraction lors du passage des intersections.", mat:"Parcours prÃ©-repÃ©rÃ©, gilets jaunes", duree:"25 min" },

  { id:"s23", bloc:"b3", niv:3, comps:["b3-gi"],
    titre:"Giratoire rÃ©el",
    obj:"Prendre sa place et circuler dans un vrai rond-point.",
    desc:"TraversÃ©e d'un giratoire peu frÃ©quentÃ© : insertion, cÃ©dez le passage, signal de sortie, Ã©vitement des voitures.",
    crit:"TraversÃ©e complÃ¨te sans infraction ni arrÃªt d'urgence.", mat:"Parcours repÃ©rÃ©, gilets, encadrants supplÃ©mentaires", duree:"20 min" },

  { id:"s24", bloc:"b3", niv:3, comps:["b3-es"],
    titre:"Emprunter piste / bande cyclable",
    obj:"Identifier et utiliser les amÃ©nagements cyclables disponibles.",
    desc:"Sortie avec tronÃ§ons variÃ©s : piste cyclable, bande cyclable, chaussÃ©e. Identifier chaque espace et s'y adapter.",
    crit:"Bon espace empruntÃ© Ã  chaque type de voie.", mat:"Parcours mixte prÃ©-repÃ©rÃ©, gilets", duree:"25 min" },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰TAT GLOBAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let state = {
  ecole:"", classe:"", effectif:24, lieu:"", seanceNum:1, seanceTotal:10,
  groupes: [
    { bloc:"b1", niv:1, effectif:8,  compsAuto:[], compsManual:[], situations:[], bilanComps:{}, bilanObs:"" },
    { bloc:"b1", niv:2, effectif:8,  compsAuto:[], compsManual:[], situations:[], bilanComps:{}, bilanObs:"" },
    { bloc:"b2", niv:2, effectif:8,  compsAuto:[], compsManual:[], situations:[], bilanComps:{}, bilanObs:"" },
  ],
};

const GRP_COLORS = ["#d62b2b","#0055a4","#e07b00","#7b5ea7","#1a8a4a"];
const GRP_NAMES  = ["Groupe A","Groupe B","Groupe C","Groupe D","Groupe E"];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goStep(n) {
  const ids = {1:"screen-1", 2:"screen-2", 3:"screen-fiche", 4:"screen-suivi", 5:"screen-questionnaire"};
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.step-btn').forEach(b => { b.classList.remove('active','done'); });
  document.getElementById(ids[n]).classList.add('active');
  document.getElementById(`sbtn-${n}`).classList.add('active');
  for(let i=1;i<n;i++) document.getElementById(`sbtn-${i}`).classList.add('done');
  if(n >= 2) readStep1();
  if(n === 2) renderStep2();
  if(n === 4) renderSuivi();
  if(n === 5) renderQuestionnaire();
  window.scrollTo(0,0);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 1
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGroupes() {
  const c = document.getElementById('groupes-list');
  if(state.groupes.length === 0) {
    c.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Aucun groupe â€” cliquez sur "+ Ajouter"</div></div>`;
    updateEffectifCheck(); return;
  }
  c.innerHTML = state.groupes.map((g,i) => {
    const isB3 = g.bloc === 'b3';
    return `
    <div class="grp-row" id="grp-row-${i}">
      <div class="grp-label">
        <span class="grp-dot" style="background:${GRP_COLORS[i%5]}"></span>
        ${GRP_NAMES[i]}
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
        <select onchange="updateGroupe(${i},'bloc',this.value)" style="flex:1;min-width:160px">
          ${Object.entries(BLOCS_META).map(([k,v])=>`<option value="${k}" ${g.bloc===k?'selected':''}>${v.shortLabel} â€“ ${v.label.split('â€“')[1].trim()}</option>`).join('')}
        </select>
        <select onchange="updateGroupe(${i},'niv',this.value)" style="flex:1;min-width:120px" ${isB3?'disabled':''}>
          <option value="1" ${g.niv===1?'selected':''}>Niveau 1</option>
          <option value="2" ${g.niv===2?'selected':''}>Niveau 2</option>
          <option value="3" ${g.niv===3?'selected':''}>Niveau 3</option>
        </select>
        ${isB3 ? `<span style="font-size:11px;color:var(--green);font-weight:700">ğŸ«â†’ğŸ›£ï¸ Classe entiÃ¨re</span>` : ''}
      </div>
      <div class="grp-effectif">
        <label class="label" style="text-align:center">Ã‰lÃ¨ves</label>
        <input type="number" value="${g.effectif}" min="1" max="60"
          onchange="updateGroupe(${i},'effectif',+this.value)"
          style="text-align:center;width:100%" ${isB3?'disabled':''}>
      </div>
      <button class="btn-ghost" onclick="removeGroupe(${i})" title="Supprimer">âœ•</button>
    </div>`;
  }).join('');
  updateEffectifCheck();
}

function updateEffectifCheck() {
  const total = state.groupes.reduce((s,g) => s + (g.bloc==='b3' ? 0 : g.effectif), 0);
  const hasB3 = state.groupes.some(g => g.bloc==='b3');
  const eff = +document.getElementById('f-effectif').value || state.effectif;
  const el = document.getElementById('effectif-check');
  if(state.groupes.length === 0) { el.innerHTML=''; return; }
  if(hasB3) {
    el.innerHTML = `<span style="color:var(--green)">â„¹ï¸ Bloc 3 : toute la classe participe ensemble (${eff} Ã©lÃ¨ves)</span>`;
    return;
  }
  if(total === eff) {
    el.innerHTML = `<span style="color:var(--green)">âœ“ RÃ©partition correcte : ${total} / ${eff} Ã©lÃ¨ves</span>`;
  } else {
    el.innerHTML = `<span style="color:var(--red)">âš  RÃ©partition : ${total} Ã©lÃ¨ves assignÃ©s pour ${eff} au total</span>`;
  }
}

function addGroupe() {
  if(state.groupes.length >= 5) return;
  state.groupes.push({ bloc:"b1", niv:1, effectif:6, compsAuto:[], compsManual:[], situations:[], bilanComps:{}, bilanObs:"" });
  renderGroupes(); autosave();
}
function removeGroupe(i) { state.groupes.splice(i,1); renderGroupes(); autosave(); }
function updateGroupe(i, field, val) {
  if(field === 'niv') {
    val = +val;
    state.groupes[i]._filterNiv = String(val); // filtre Ã©tape 2 suit le niveau
  }
  state.groupes[i][field] = val;
  // Si on passe en B3 : effectif = total classe
  if(field === 'bloc' && val === 'b3') {
    state.groupes[i].effectif = +document.getElementById('f-effectif').value || state.effectif;
    state.groupes[i].niv = 3;
    if(state.groupes.length > 1) {
      if(confirm('En Bloc 3, toute la classe participe ensemble. Supprimer les autres groupes ?')) {
        state.groupes = [state.groupes[i]];
      }
    }
  }
  renderGroupes(); autosave();
}
function readStep1() {
  state.ecole = document.getElementById('f-ecole').value;
  state.classe = document.getElementById('f-classe').value;
  state.effectif = +document.getElementById('f-effectif').value;
  state.lieu = document.getElementById('f-lieu').value;
  state.seanceNum = +document.getElementById('f-seance-num').value;
  state.seanceTotal = +document.getElementById('f-seance-total').value;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 2 â€” SITUATIONS PAR GROUPE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStep2() {
  const c = document.getElementById('groupes-sit-sections');
  c.innerHTML = state.groupes.map((g,i) => renderGroupeSection(g,i)).join('');
}

function renderGroupeSection(g, i) {
  const meta = BLOCS_META[g.bloc] || BLOCS_META.b1;
  const blocComps = (COMPETENCES[g.bloc]||{comps:[]}).comps;
  const color = GRP_COLORS[i%5];
  const isB3 = g.bloc === 'b3';

  // filtres actifs pour ce groupe
  const filterBloc = g._filterBloc || g.bloc;
  const filterNiv = g._filterNiv !== undefined ? g._filterNiv : String(g.niv);

  // situations filtrÃ©es
  let sits = SITUATIONS;
  sits = sits.filter(s => s.bloc === filterBloc);
  if(filterNiv !== 'all') sits = sits.filter(s => s.niv === +filterNiv);

  const allBlocs = Object.keys(BLOCS_META);

  return `
  <div class="grp-section" id="grp-sec-${i}">
    <div class="grp-section-head" style="background:${meta.bg}">
      <div class="grp-num" style="background:${color}">${i+1}</div>
      <div class="info">
        <div class="gsh-title">${GRP_NAMES[i]} Â· ${isB3 ? state.effectif : g.effectif} Ã©lÃ¨ves</div>
        <div class="gsh-sub">${meta.label} Â· ${meta.contexte}</div>
      </div>
      <span class="bloc-tag b${g.bloc.slice(1)}">${meta.icon} ${meta.shortLabel}</span>
    </div>
    <div class="grp-section-body">
      ${isB3 ? `<div class="bloc3-notice">
        <strong>ğŸ›£ï¸ Bloc 3 â€” Toute la classe sort ensemble</strong>
        En Bloc 3, aucun sous-groupe n'est sÃ©parÃ© Ã  l'Ã©cole. La diffÃ©renciation s'opÃ¨re via les rÃ´les (cycliste, observateur, signaleur) ou les positions dans la file. Les critÃ¨res d'Ã©valuation sont communs Ã  tous les Ã©lÃ¨ves.
      </div>` : ''}

      <!-- CompÃ©tences visÃ©es -->
      <div class="comp-section">
        <div class="comp-title">CompÃ©tences du livret visÃ©es pour cette sÃ©ance</div>
        <div style="font-size:11px;color:#7a8a99;margin-bottom:8px;font-style:italic">
          Les compÃ©tences <span style="display:inline-flex;align-items:center;gap:3px;background:#e8f0fb;border:1.5px solid var(--blue);border-radius:10px;padding:1px 7px;font-size:10px;color:var(--blue);font-weight:700;font-style:normal">auto âœ¦</span> sont dÃ©duites automatiquement des situations choisies. Cliquez pour confirmer ou ajouter.
        </div>
        <div class="comp-pills">
          ${blocComps.map(comp => {
            const isAuto   = (g.compsAuto||[]).includes(comp.id);
            const isManual = (g.compsManual||[]).includes(comp.id);
            let cls = '', badge = '';
            if(isAuto && isManual) {
              cls = 'sel-both';
              badge = `<span class="comp-pill-badge badge-auto">âœ¦ auto</span><span class="comp-pill-badge badge-manual">+ vous</span>`;
            } else if(isAuto) {
              cls = 'sel-auto';
              badge = `<span class="comp-pill-badge badge-auto-blue">âœ¦ auto</span>`;
            } else if(isManual) {
              cls = 'sel-manual';
              badge = `<span class="comp-pill-badge badge-manual" style="background:rgba(255,255,255,.25);color:white">+ vous</span>`;
            }
            return `<div class="comp-pill ${cls}" onclick="toggleComp(${i},'${comp.id}')" title="${comp.detail} (N${comp.niv})">
              ${comp.label}
              <span class="comp-pill-niv">N${comp.niv}</span>
              ${badge}
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- Filtres situations -->
      <div class="filters-bar">
        <div class="filter-group">
          <div class="filter-label">ğŸ“‚ Filtrer par bloc</div>
          <div class="bloc-selector">
            ${allBlocs.map(bk => {
              const bm = BLOCS_META[bk];
              return `<div class="bloc-pill b${bk.slice(1)} ${filterBloc===bk?'sel':''}" onclick="setFilter(${i},'bloc','${bk}')">
                <span class="bloc-dot" style="background:${bm.color}"></span>${bm.shortLabel}
              </div>`;
            }).join('')}
          </div>
        </div>
        <div class="filter-group">
          <div class="filter-label">ğŸ“Š Filtrer par niveau</div>
          <div class="niv-selector">
            <div class="niv-pill ${filterNiv==='all'?'sel':''}" onclick="setFilter(${i},'niv','all')">Tous</div>
            <div class="niv-pill ${filterNiv==='1'?'sel':''}" onclick="setFilter(${i},'niv','1')">Niveau 1</div>
            <div class="niv-pill ${filterNiv==='2'?'sel':''}" onclick="setFilter(${i},'niv','2')">Niveau 2</div>
            <div class="niv-pill ${filterNiv==='3'?'sel':''}" onclick="setFilter(${i},'niv','3')">Niveau 3</div>
          </div>
        </div>
      </div>

      <!-- Situations -->
      <div class="comp-section">
        <div class="comp-title">Situations (sÃ©lectionnez 2 Ã  4) â€” ${sits.length} disponibles</div>
        ${sits.length === 0
          ? `<div class="alert alert-warn">âš  Aucune situation pour ces filtres. Modifiez le filtre Bloc ou Niveau.</div>`
          : `<div class="sit-grid">${sits.map(s => renderSitCard(s,i)).join('')}</div>`}
      </div>

      <!-- Bilan d'Ã©valuation -->
      <div class="bilan-section">
        <div class="bilan-title">ğŸ“Š Bilan d'Ã©valuation â€” Ã€ renseigner aprÃ¨s la sÃ©ance</div>
        <div class="bilan-grid">
          ${effectiveComps(g).length === 0
            ? `<div style="font-size:12px;color:#aab;font-style:italic">SÃ©lectionnez des situations ou des compÃ©tences ci-dessus pour activer le bilan.</div>`
            : effectiveComps(g).map(cid => {
                const cLabel = getCompLabel(cid);
                const val = (g.bilanComps||{})[cid] || '';
                return `<div class="bilan-row">
                  <div class="bilan-comp-name">${cLabel}</div>
                  <div class="bilan-btns">
                    <button class="bilan-btn ${val==='ok'?'sel-ok':''}" onclick="setBilan(${i},'${cid}','ok')">âœ“ Acquis</button>
                    <button class="bilan-btn ${val==='prog'?'sel-prog':''}" onclick="setBilan(${i},'${cid}','prog')">âŸ³ En cours</button>
                    <button class="bilan-btn ${val==='non'?'sel-non':''}" onclick="setBilan(${i},'${cid}','non')">âœ— Non atteint</button>
                  </div>
                </div>`;
              }).join('')}
        </div>
        <div class="bilan-obs">
          <div class="label">Observations libres de l'enseignant</div>
          <textarea placeholder="Ex : Groupe A maÃ®trise bien le freinage, difficultÃ©s sur le slalom. 3 Ã©lÃ¨ves ont encore besoin de travailler l'Ã©quilibre en virageâ€¦" onchange="setBilanObs(${i},this.value)">${g.bilanObs||''}</textarea>
        </div>
      </div>

    </div>
  </div>`;
}

function renderSitCard(s, gi) {
  const sel = (state.groupes[gi].situations||[]).includes(s.id);
  const meta = BLOCS_META[s.bloc];
  const spiralInfo = detectSpiral(s);
  return `
  <div class="sit-card ${sel?'selected':''}" id="sit-${gi}-${s.id}" onclick="toggleSit(${gi},'${s.id}')">
    <div class="sit-card-top">
      <div class="sit-check">${sel?'âœ“':''}</div>
      <div style="flex:1">
        <div class="sit-title">${s.titre}</div>
        <div class="sit-comp">${s.comps.map(c => getCompLabel(c)).join(' Â· ')}</div>
        <div class="sit-badges">
          <span class="bloc-tag b${s.bloc.slice(1)}" style="font-size:9px">${meta.icon} ${meta.shortLabel}</span>
          <span class="sit-niv-badge niv-${s.niv}">Niveau ${s.niv}</span>
          ${spiralInfo ? `<span class="sit-spiral">â†©ï¸ Spiral ${spiralInfo}</span>` : ''}
        </div>
      </div>
      <span style="font-size:11px;color:#8a9aaa;font-weight:700;white-space:nowrap">${s.duree}</span>
    </div>
    <div class="sit-detail">
      <div style="font-size:12px;color:#445;margin-bottom:6px">${s.desc}</div>
      <div class="sit-meta">
        <span class="sit-tag tag-obj">ğŸ¯ ${s.obj}</span>
        <span class="sit-tag tag-crit">âœ“ ${s.crit}</span>
        <span class="sit-tag" style="background:#f3f3f3;color:#666">ğŸ“¦ ${s.mat}</span>
      </div>
    </div>
  </div>`;
}

function detectSpiral(sit) {
  // VÃ©rifie si une compÃ©tence de cette situation rÃ©apparaÃ®t dans d'autres blocs
  for(const cid of sit.comps) {
    for(const [bk, bd] of Object.entries(COMPETENCES)) {
      const comp = bd.comps.find(c => c.id === cid);
      if(comp && comp.spiral && comp.spiral.length > 0) {
        return comp.spiral.map(b => BLOCS_META[b]?.shortLabel || b).join('/');
      }
    }
  }
  return null;
}

function getCompLabel(id) {
  for(const bloc of Object.values(COMPETENCES)) {
    const c = bloc.comps.find(c => c.id === id);
    if(c) return c.label;
  }
  return id;
}

function setFilter(gi, type, val) {
  if(type === 'bloc') state.groupes[gi]._filterBloc = val;
  if(type === 'niv')  state.groupes[gi]._filterNiv  = val; // 'all', '1', '2' ou '3'
  const sec = document.getElementById(`grp-sec-${gi}`);
  if(sec) sec.outerHTML = renderGroupeSection(state.groupes[gi], gi);
}

/* â”€â”€ helpers â”€â”€ */
function effectiveComps(g) {
  // Union de compsAuto et compsManual, sans doublons
  const all = new Set([...(g.compsAuto||[]), ...(g.compsManual||[])]);
  return [...all];
}

function syncCompsAuto(gi) {
  // Recalcule les compÃ©tences automatiques Ã  partir des situations sÃ©lectionnÃ©es
  const g = state.groupes[gi];
  const auto = new Set();
  (g.situations||[]).forEach(sid => {
    const s = SITUATIONS.find(x => x.id === sid);
    if(s) s.comps.forEach(cid => auto.add(cid));
  });
  g.compsAuto = [...auto];
}

function toggleComp(gi, cid) {
  const g = state.groupes[gi];
  if(!g.compsManual) g.compsManual = [];
  const isAuto   = (g.compsAuto||[]).includes(cid);
  const isManual = g.compsManual.includes(cid);

  if(isAuto && !isManual) {
    // Auto seule â†’ on confirme manuellement (sel-both)
    g.compsManual.push(cid);
  } else if(isAuto && isManual) {
    // Les deux â†’ on retire la confirmation manuelle (retour Ã  sel-auto)
    g.compsManual = g.compsManual.filter(c => c !== cid);
  } else if(!isAuto && isManual) {
    // Manuel seul â†’ on retire
    g.compsManual = g.compsManual.filter(c => c !== cid);
  } else {
    // Aucune â†’ ajout manuel
    g.compsManual.push(cid);
  }
  const sec = document.getElementById(`grp-sec-${gi}`);
  if(sec) sec.outerHTML = renderGroupeSection(g, gi);
  autosave();
}

function toggleSit(gi, sid) {
  const g = state.groupes[gi];
  if(!g.situations) g.situations = [];
  const idx = g.situations.indexOf(sid);
  if(idx >= 0) {
    g.situations.splice(idx, 1);
  } else {
    if(g.situations.length >= 4) { alert('Maximum 4 situations par groupe.'); return; }
    g.situations.push(sid);
  }
  syncCompsAuto(gi);
  const sec = document.getElementById(`grp-sec-${gi}`);
  if(sec) sec.outerHTML = renderGroupeSection(g, gi);
  autosave();
}

function setBilan(gi, cid, val) {
  const g = state.groupes[gi];
  if(!g.bilanComps) g.bilanComps = {};
  g.bilanComps[cid] = g.bilanComps[cid] === val ? '' : val;
  const sec = document.getElementById(`grp-sec-${gi}`);
  if(sec) sec.outerHTML = renderGroupeSection(g, gi);
  autosave();
}

function setBilanObs(gi, val) {
  state.groupes[gi].bilanObs = val;
  autosave();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 3 â€” FICHE DE SÃ‰ANCE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generateFiche() {
  readStep1();
  goStep(3);
  const out = document.getElementById('fiche-output');
  const nbGroupes = state.groupes.length;
  const colW = `repeat(${Math.min(nbGroupes,3)}, 1fr)`;

  const allMat = new Set();
  state.groupes.forEach(g => {
    (g.situations||[]).forEach(sid => {
      const s = SITUATIONS.find(x=>x.id===sid);
      if(s) s.mat.split(',').forEach(m => allMat.add(m.trim()));
    });
  });

  const date = new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});

  out.innerHTML = `
  <div class="fiche-banner">
    <div>
      <div class="fiche-title">Fiche de SÃ©ance<br><span>Savoir Rouler Ã  VÃ©lo</span></div>
      <div class="fiche-subtitle">SÃ©ance ${state.seanceNum} / ${state.seanceTotal} Â· GÃ©nÃ©rÃ©e le ${date}</div>
      <div class="fiche-chips">
        ${state.ecole ? `<div class="fiche-chip">ğŸ« ${state.ecole}</div>` : ''}
        ${state.classe ? `<div class="fiche-chip">ğŸ‘¨â€ğŸ« ${state.classe}</div>` : ''}
        ${state.lieu ? `<div class="fiche-chip">ğŸ“ ${state.lieu}</div>` : ''}
        <div class="fiche-chip">ğŸ‘¥ ${state.effectif} Ã©lÃ¨ves Â· ${nbGroupes} groupe${nbGroupes>1?'s':''}</div>
      </div>
    </div>
    <div style="text-align:right">
      <div style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:52px;color:rgba(255,255,255,.15);line-height:1">${state.seanceNum}</div>
      <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:-4px">SÃ‰ANCE</div>
    </div>
  </div>

  <div class="fiche-infos" style="grid-template-columns:repeat(${Math.min(nbGroupes,4)},1fr)">
    ${state.groupes.map((g,i) => {
      const meta = BLOCS_META[g.bloc]||BLOCS_META.b1;
      return `<div class="fi-cell">
        <div class="fi-lbl" style="color:${GRP_COLORS[i%5]}">${GRP_NAMES[i]}</div>
        <div class="fi-val">${g.bloc==='b3'?state.effectif:g.effectif} Ã©lÃ¨ves</div>
        <div style="margin-top:5px">
          <span class="bloc-tag b${g.bloc.slice(1)}" style="font-size:9px">${meta.icon} ${meta.shortLabel}</span>
          ${g.bloc!=='b3' ? `<span class="bloc-tag" style="background:#f3f3f3;color:#555;font-size:9px;margin-left:3px">N${g.niv}</span>` : ''}
        </div>
      </div>`;
    }).join('')}
  </div>

  <div class="fiche-cols" style="grid-template-columns:${colW}">
    ${state.groupes.map((g,i) => {
      const meta = BLOCS_META[g.bloc]||BLOCS_META.b1;
      const color = GRP_COLORS[i%5];
      const compsViseesLabels = effectiveComps(g).map(c => getCompLabel(c));
      const sitsData = (g.situations||[]).map(sid => SITUATIONS.find(s=>s.id===sid)).filter(Boolean);
      return `
      <div class="fiche-col">
        <div class="fiche-col-head" style="background:${meta.bg}">
          <span class="fcol-dot" style="background:${color}"></span>
          <div>
            <div class="fcol-title">${GRP_NAMES[i]} <span style="font-weight:400;font-size:12px">Â· ${g.bloc==='b3'?state.effectif:g.effectif} Ã©lÃ¨ves</span></div>
            <div class="fcol-sub">${meta.label} ${g.bloc!=='b3'?`Â· Niveau ${g.niv}`:''}</div>
          </div>
        </div>
        <div class="fcol-comp">
          ${compsViseesLabels.length > 0
            ? `<span style="font-weight:700;color:#1a3a5a">CompÃ©tences visÃ©es :</span> ${compsViseesLabels.join(' Â· ')}`
            : `<span style="color:#aab">Aucune compÃ©tence sÃ©lectionnÃ©e</span>`}
        </div>
        ${sitsData.length === 0
          ? `<div class="fiche-sit"><span style="color:#aab;font-size:12px;font-style:italic">Aucune situation sÃ©lectionnÃ©e</span></div>`
          : sitsData.map((s,si) => `
            <div class="fiche-sit">
              <span class="fiche-sit-num" style="background:${color}">${si+1}</span>
              <span class="fiche-sit-name">${s.titre}</span>
              <div class="fiche-sit-obj">ğŸ¯ ${s.obj}</div>
              <div class="fiche-sit-crit">âœ“ ${s.crit}</div>
              <div class="fiche-sit-mat">ğŸ“¦ ${s.mat} Â· <em>${s.duree}</em></div>
            </div>`).join('')}
      </div>`;
    }).join('')}
  </div>

  ${allMat.size > 0 ? `
  <div class="fiche-mat-bar">
    <div class="mat-title">ğŸ“¦ MatÃ©riel total Ã  prÃ©parer</div>
    ${[...allMat].map(m=>`<span class="mat-chip">${m}</span>`).join('')}
  </div>` : ''}

  <!-- BILAN PAR GROUPE -->
  <div class="fiche-bilan-section">
    <div class="fiche-bilan-title">ğŸ“Š Bilan d'Ã©valuation â€” Par groupe</div>
    <div class="fiche-bilan-cols" style="grid-template-columns:repeat(${Math.min(nbGroupes,3)},1fr)">
      ${state.groupes.map((g,i) => {
        const meta = BLOCS_META[g.bloc]||BLOCS_META.b1;
        const color = GRP_COLORS[i%5];
        const compsLabels = effectiveComps(g).map(cid => ({ id:cid, label:getCompLabel(cid), val:(g.bilanComps||{})[cid]||'' }));
        return `
        <div class="fiche-bilan-grp">
          <div class="fiche-bilan-grp-head" style="background:${meta.bg}">
            <span class="fcol-dot" style="background:${color}"></span>
            <span class="fiche-bilan-grp-name">${GRP_NAMES[i]}</span>
            <span class="bloc-tag b${g.bloc.slice(1)}" style="margin-left:auto;font-size:9px">${meta.shortLabel}</span>
          </div>
          <div class="fiche-bilan-grp-body">
            ${compsLabels.length === 0
              ? `<div style="font-size:11px;color:#aab;font-style:italic;padding:6px 0">Aucune compÃ©tence sÃ©lectionnÃ©e</div>`
              : compsLabels.map(c => `
                <div class="fiche-bilan-comp-row">
                  <span>${c.label}</span>
                  <div class="fiche-bilan-scale">
                    <span class="fbs-item ${c.val==='ok'?'fbs-ok':''}">âœ“ Acquis</span>
                    <span class="fbs-item ${c.val==='prog'?'fbs-prog':''}">âŸ³ En cours</span>
                    <span class="fbs-item ${c.val==='non'?'fbs-non':''}">âœ— Non atteint</span>
                  </div>
                </div>`).join('')}
            <div class="fiche-bilan-obs">
              <div class="fiche-bilan-obs-label">Observations</div>
              <div class="fiche-bilan-obs-box">${g.bilanObs ? g.bilanObs : 'Ã€ complÃ©ter aprÃ¨s la sÃ©anceâ€¦'}</div>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CORRESPONDANCE QUESTIONNAIRE Ã‰LÃˆVE â†” COMPÃ‰TENCES
   Source : Annexe 3, questionnaire officiel SRAV
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QST_FAMILLES = [
  {
    id:"qf1", label:"Ã‰quipement & sÃ©curitÃ©", color:"#7b5ea7",
    items:[
      { id:"q1a", label:"Mettre mon casque et vÃ©rifier les Ã©lÃ©ments de sÃ©curitÃ© (freins, pneusâ€¦)", comps:["b0-eq","b1-eq","b2-eq","b3-eq"] },
    ]
  },
  {
    id:"qf2", label:"MaÃ®triser mon Ã©quilibre", color:"#d62b2b",
    items:[
      { id:"q2a", label:"Rouler en libÃ©rant des appuis (pieds ou mains)", comps:["b0-mv","b1-ap"] },
      { id:"q2b", label:"Sauter un obstacle (monter, descendre d'une planche)", comps:["b1-vi"] },
    ]
  },
  {
    id:"qf3", label:"MaÃ®triser ma trajectoire", color:"#d62b2b",
    items:[
      { id:"q3a", label:"Rouler en ligne droite", comps:["b1-ld"] },
      { id:"q3b", label:"RÃ©aliser un enchaÃ®nement de virages", comps:["b1-ld","b1-ci"] },
      { id:"q3c", label:"RÃ©aliser une trajectoire montante (rouler en danseuse)", comps:["b1-vt"] },
      { id:"q3d", label:"RÃ©aliser une trajectoire descendante (freiner avec la roue arriÃ¨re)", comps:["b1-fr"] },
    ]
  },
  {
    id:"qf4", label:"MaÃ®triser ma vitesse", color:"#e07b00",
    items:[
      { id:"q4a", label:"AccÃ©lÃ©rer, pÃ©daler avec plus de force", comps:["b1-vt"] },
      { id:"q4b", label:"Freiner ou pÃ©daler avec moins de force", comps:["b1-fr"] },
      { id:"q4c", label:"Entretenir une vitesse constante", comps:["b1-vt"] },
      { id:"q4d", label:"Utiliser le dÃ©railleur en fonction du terrain", comps:["b1-vt"] },
    ]
  },
  {
    id:"qf5", label:"GÃ©rer une distance", color:"#e07b00",
    items:[
      { id:"q5a", label:"Rouler en file indienne et gÃ©rer ma distance Ã  l'autre", comps:["b2-au","b3-dr"] },
      { id:"q5b", label:"Rouler Ã  2 cÃ´te Ã  cÃ´te", comps:["b2-au"] },
      { id:"q5c", label:"Rouler en groupe", comps:["b2-au","b3-dr"] },
      { id:"q5d", label:"M'arrÃªter au signal sans entrer en collision avec le vÃ©lo devant moi", comps:["b1-fr","b2-au"] },
    ]
  },
  {
    id:"qf6", label:"GÃ©rer un parcours / sortie sur route", color:"#1a8a4a",
    items:[
      { id:"q6a", label:"Respecter les rÃ¨gles du code de la route", comps:["b2-cr","b3-cr","b1-pan","b2-pan","b3-pan"] },
      { id:"q6b", label:"Avertir d'un dÃ©passement ou d'un changement de direction", comps:["b2-co","b3-us"] },
      { id:"q6c", label:"PrÃ©venir d'un obstacle particulier", comps:["b2-co"] },
      { id:"q6d", label:"Appliquer les rÃ¨gles de traversÃ©e de route ou de carrefour", comps:["b2-gi","b3-gi","b3-cr"] },
      { id:"q6e", label:"Emprunter la bonne voie (piste cyclable, bande, chaussÃ©e)", comps:["b2-es","b3-es"] },
    ]
  },
  {
    id:"qf7", label:"En cas d'accident", color:"#1c2b3a",
    items:[
      { id:"q7a", label:"PrÃ©venir les autres sans prendre de risque", comps:[] },
      { id:"q7b", label:"Appeler le numÃ©ro d'urgence adaptÃ© et donner un message d'alerte", comps:[] },
    ]
  },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CYCLE â€” Ã‰TAT PERSISTANT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let cycle = { ecole:"", classe:"", seances:[] };

function cycleCompsWorked() {
  const s = new Set();
  cycle.seances.forEach(sn => sn.groupes.forEach(g => {
    [...(g.compsAuto||[]), ...(g.compsManual||[])].forEach(c => s.add(c));
  }));
  return s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAUVEGARDE / EXPORT / IMPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sauvegarderSeance() {
  readStep1();
  // Lire les bilans rapides depuis l'UI de l'Ã©tape 4
  syncBilanRapide();
  const snap = {
    num: state.seanceNum,
    total: state.seanceTotal,
    date: new Date().toLocaleDateString('fr-FR'),
    lieu: state.lieu,
    ecole: state.ecole,
    classe: state.classe,
    effectif: state.effectif,
    groupes: JSON.parse(JSON.stringify(state.groupes))
  };
  const idx = cycle.seances.findIndex(s => s.num === snap.num);
  if(idx >= 0) cycle.seances[idx] = snap;
  else cycle.seances.push(snap);
  cycle.seances.sort((a,b) => a.num - b.num);
  cycle.ecole = state.ecole;
  cycle.classe = state.classe;
  return snap;
}

function exporterCycle() {
  sauvegarderSeance();
  const nom = `SRAV-${(cycle.classe||'Classe').replace(/[\s\/\\]/g,'-')}-cycle.json`;
  const blob = new Blob([JSON.stringify(cycle, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = nom;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);
  showToast(`ğŸ’¾ Cycle sauvegardÃ© : ${nom}`);
  renderSuivi();
}

function importCycle(input) {
  const file = input.files && input.files[0];
  if(!file) return;
  _readCycleFile(file);
  input.value = '';
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.remove('drag');
  const file = e.dataTransfer.files && e.dataTransfer.files[0];
  if(!file || !file.name.endsWith('.json')) {
    showToast('âš  DÃ©posez un fichier .json valide');
    return;
  }
  _readCycleFile(file);
}

function _readCycleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if(!Array.isArray(data.seances)) throw new Error('Format invalide');
      cycle = data;
      // Restaurer depuis la derniÃ¨re sÃ©ance sauvegardÃ©e
      const last = cycle.seances[cycle.seances.length - 1];
      if(last) {
        state.seanceNum   = (last.num || 0) + 1;
        state.seanceTotal = last.total || state.seanceTotal;
        state.lieu        = last.lieu  || '';
        state.effectif    = last.effectif || state.effectif;
        state.ecole       = last.ecole || cycle.ecole || '';
        state.classe      = last.classe || cycle.classe || '';
        // Copie des groupes de la derniÃ¨re sÃ©ance â€” bilans remis Ã  zÃ©ro pour la nouvelle
        state.groupes = JSON.parse(JSON.stringify(last.groupes)).map(g => ({
          ...g,
          bilanComps: {},
          bilanObs:   '',
          situations: [],        // sÃ©ance suivante = nouvelle sÃ©lection
          compsAuto:  [],
          _filterBloc: g.bloc,
          _filterNiv:  String(g.niv)
        }));
        // Sync champs Ã©tape 1
        const fields = {
          'f-ecole': state.ecole, 'f-classe': state.classe,
          'f-effectif': state.effectif, 'f-lieu': state.lieu,
          'f-seance-num': state.seanceNum, 'f-seance-total': state.seanceTotal
        };
        Object.entries(fields).forEach(([id,val]) => {
          const el = document.getElementById(id);
          if(el) el.value = val;
        });
        renderGroupes();
      }
      renderSuivi();
      showToast(`âœ“ ${cycle.seances.length} sÃ©ance(s) chargÃ©e(s) â€” prÃªt pour la sÃ©ance ${state.seanceNum}`);
      autosave();
    } catch(err) {
      showToast('âš  Fichier invalide â€” utilisez un fichier .json exportÃ© par cet outil');
    }
  };
  reader.readAsText(file);
}

/* â”€â”€â”€â”€â”€â”€ Bilan rapide (dans l'Ã©cran Suivi) â”€â”€â”€â”€â”€â”€ */
function renderBilanRapide() {
  const c = document.getElementById('bilan-rapide-list');
  if(!c) return;
  if(state.groupes.length === 0) {
    c.innerHTML = `<div style="padding:16px;font-size:13px;color:#aab;font-style:italic">Aucun groupe configurÃ©. Commencez par l'Ã©tape 1.</div>`;
    return;
  }
  c.innerHTML = state.groupes.map((g,i) => {
    const meta  = BLOCS_META[g.bloc] || BLOCS_META.b1;
    const color = GRP_COLORS[i%5];
    const comps = effectiveComps(g);
    return `
    <div style="border-bottom:1px solid var(--line);padding:14px 18px" id="br-grp-${i}">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <span style="width:10px;height:10px;border-radius:50%;background:${color};display:inline-block"></span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px">${GRP_NAMES[i]}</span>
        <span class="bloc-tag b${g.bloc.slice(1)}" style="font-size:9px">${meta.shortLabel}</span>
        <span style="font-size:11px;color:#7a8a99;margin-left:4px">${g.bloc==='b3'?state.effectif:g.effectif} Ã©lÃ¨ves</span>
      </div>
      ${comps.length === 0
        ? `<div style="font-size:12px;color:#aab;font-style:italic">Aucune compÃ©tence â€” sÃ©lectionnez des situations en Ã©tape 2 d'abord.</div>`
        : `<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
            ${comps.map(cid => {
              const val = (g.bilanComps||{})[cid] || '';
              return `<div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:var(--mist);border-radius:6px;padding:6px 10px">
                <span style="font-size:12px;font-weight:700;color:var(--slate)">${getCompLabel(cid)}</span>
                <div style="display:flex;gap:4px">
                  <button class="bilan-btn ${val==='ok'?'sel-ok':''}" onclick="setBilanSuivi(${i},'${cid}','ok')">âœ“ Acquis</button>
                  <button class="bilan-btn ${val==='prog'?'sel-prog':''}" onclick="setBilanSuivi(${i},'${cid}','prog')">âŸ³ En cours</button>
                  <button class="bilan-btn ${val==='non'?'sel-non':''}" onclick="setBilanSuivi(${i},'${cid}','non')">âœ— Non atteint</button>
                </div>
              </div>`;
            }).join('')}
          </div>
          <div>
            <label class="label">Observations (Ã©lÃ¨ves Ã  surveiller, points clÃ©sâ€¦)</label>
            <textarea rows="2" placeholder="Ex : Lucas â€” freinage encore trop tardif. Emma prÃªte pour passer au niveau 2â€¦" 
              onchange="setBilanObsSuivi(${i},this.value)"
              style="font-size:13px">${g.bilanObs||''}</textarea>
          </div>`}
    </div>`;
  }).join('');
}

function setBilanSuivi(gi, cid, val) {
  const g = state.groupes[gi];
  if(!g.bilanComps) g.bilanComps = {};
  g.bilanComps[cid] = g.bilanComps[cid] === val ? '' : val;
  renderBilanRapide();
  autosave();
}

function setBilanObsSuivi(gi, val) {
  state.groupes[gi].bilanObs = val;
  autosave();
}

function syncBilanRapide() {
  // Les bilans sont dÃ©jÃ  dans state.groupes via setBilanSuivi / setBilanObsSuivi
  // Les textareas : on relit pour ne pas perdre du texte non dÃ©clenchÃ© par onchange
  state.groupes.forEach((g,i) => {
    const wrap = document.getElementById(`br-grp-${i}`);
    if(!wrap) return;
    const ta = wrap.querySelector('textarea');
    if(ta) g.bilanObs = ta.value;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDU SUIVI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSuivi() {
  renderBilanRapide();
  const hasSeances = cycle.seances.length > 0;
  document.getElementById('cycle-count').textContent = hasSeances ? `${cycle.seances.length} sÃ©ance(s) dans le cycle` : '';

  // â”€â”€ SynthÃ¨se progression â”€â”€
  const wrap = document.getElementById('cycle-summary-wrap');
  if(!hasSeances) { wrap.innerHTML = ''; }
  else {
    const allComps = new Map();
    cycle.seances.forEach(sn => sn.groupes.forEach(g => {
      [...(g.compsAuto||[]), ...(g.compsManual||[])].forEach(cid => {
        if(!allComps.has(cid)) allComps.set(cid, getCompLabel(cid));
      });
    }));

    wrap.innerHTML = allComps.size === 0 ? '' : `
    <div class="cycle-summary card" style="margin-bottom:16px">
      <div class="cycle-summary-head card-head">
        <div class="card-head-icon" style="background:#e6f4ec">ğŸ“ˆ</div>
        <span class="card-title">Progression sur le cycle â€” ${cycle.seances.length} sÃ©ance(s)</span>
        <span style="margin-left:auto;font-size:10px;color:#7a8a99;display:flex;gap:8px;align-items:center">
          <span><span class="cycle-dot ok" style="display:inline-flex;width:12px;height:12px;font-size:7px"> </span> Acquis</span>
          <span><span class="cycle-dot en" style="display:inline-flex;width:12px;height:12px;font-size:7px"> </span> En cours</span>
          <span><span class="cycle-dot non" style="display:inline-flex;width:12px;height:12px;font-size:7px"> </span> Non atteint</span>
          <span><span class="cycle-dot nd" style="display:inline-flex;width:12px;height:12px;font-size:7px"> </span> TravaillÃ©</span>
        </span>
      </div>
      ${[...allComps.entries()].map(([cid, clabel]) => {
        const dots = cycle.seances.map(sn => {
          for(const g of sn.groupes) {
            if([...(g.compsAuto||[]),...(g.compsManual||[])].includes(cid)) {
              const val = (g.bilanComps||{})[cid] || 'nd';
              const titles = {ok:'Acquis',prog:'En cours',non:'Non atteint',nd:'TravaillÃ© sans bilan'};
              return `<div class="cycle-dot ${val==='prog'?'en':val}" title="S${sn.num} Â· ${titles[val]||val}">${sn.num}</div>`;
            }
          }
          return '';
        }).filter(Boolean).join('');
        return `<div class="cycle-comp-row">
          <div class="cycle-comp-label">${clabel}</div>
          <div class="cycle-comp-dots">${dots||'<span style="font-size:11px;color:#aab;font-style:italic">non encore Ã©valuÃ©</span>'}</div>
        </div>`;
      }).join('')}
    </div>`;
  }

  // â”€â”€ Historique sÃ©ances â”€â”€
  const list = document.getElementById('seance-history-list');
  if(!hasSeances) {
    list.innerHTML = `<div class="empty" style="padding:24px"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Aucune sÃ©ance sauvegardÃ©e</div><p style="font-size:12px;color:#aab;margin-top:6px">Remplissez le bilan ci-dessus et cliquez "Sauvegarder &amp; exporter"</p></div>`;
    return;
  }
  list.innerHTML = cycle.seances.map((sn,idx) => {
    const groupsDesc = sn.groupes.map((g,gi) => `${GRP_NAMES[gi]} (${(BLOCS_META[g.bloc]||BLOCS_META.b1).shortLabel})`).join(', ');
    return `
    <div class="seance-card">
      <div class="seance-card-head" onclick="toggleSeanceCard(${idx})">
        <div class="seance-num">${sn.num}</div>
        <div class="seance-meta">
          <div class="seance-meta-title">SÃ©ance ${sn.num} / ${sn.total} Â· ${sn.date}</div>
          <div class="seance-meta-sub">${sn.lieu ? sn.lieu+' Â· ' : ''}${groupsDesc}</div>
        </div>
        <span class="seance-expand" id="seance-expand-${idx}">â–¼ Voir le bilan</span>
      </div>
      <div class="seance-card-body" id="seance-body-${idx}">
        ${sn.groupes.map((g,gi) => {
          const meta  = BLOCS_META[g.bloc]||BLOCS_META.b1;
          const comps = [...new Set([...(g.compsAuto||[]),...(g.compsManual||[])])];
          const valLabels = {ok:'âœ“ Acquis', prog:'âŸ³ En cours', non:'âœ— Non atteint', nd:'â€” Sans bilan'};
          return comps.length === 0
            ? `<p style="font-size:12px;color:#aab;font-style:italic;margin-bottom:8px">${GRP_NAMES[gi]} â€” aucune compÃ©tence</p>`
            : `<div style="margin-bottom:14px">
                <div style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:${meta.color};margin-bottom:6px">${GRP_NAMES[gi]} Â· ${meta.label}</div>
                <table class="prog-table">
                  <tr><th>CompÃ©tence</th><th>RÃ©sultat du groupe</th></tr>
                  ${comps.map(cid => {
                    const val = (g.bilanComps||{})[cid]||'nd';
                    return `<tr><td>${getCompLabel(cid)}</td><td><span class="prog-dot prog-${val==='prog'?'en':val}">${valLabels[val]||val}</span></td></tr>`;
                  }).join('')}
                </table>
                ${g.bilanObs ? `<div style="font-size:11px;color:#5a7090;margin-top:6px;padding:6px 10px;background:#f7f9fb;border-radius:4px;font-style:italic">ğŸ’¬ ${g.bilanObs}</div>` : ''}
              </div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

function toggleSeanceCard(idx) {
  const body = document.getElementById(`seance-body-${idx}`);
  const exp  = document.getElementById(`seance-expand-${idx}`);
  const open = body.classList.toggle('open');
  exp.textContent = open ? 'â–² Masquer' : 'â–¼ Voir le bilan';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUESTIONNAIRE Ã‰LÃˆVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderQuestionnaire() {
  const worked = cycleCompsWorked();
  const hideUnused = document.getElementById('qst-hide-unused')?.checked;
  const date = new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});

  const body = QST_FAMILLES.map(fam => {
    const items = fam.items.filter(it => {
      if(hideUnused && it.comps.length > 0 && !it.comps.some(c => worked.has(c))) return false;
      return true;
    });
    if(items.length === 0) return '';

    const rows = items.map(it => {
      const isWorked = it.comps.length === 0 || it.comps.some(c => worked.has(c));
      const dimStyle = (!isWorked) ? 'opacity:.35' : '';
      return `<div class="qst-item" style="${dimStyle}">
        <div class="qst-item-label">${!isWorked ? 'â—‹ ' : ''}${it.label}</div>
        <div class="qst-check-cell"><div class="qst-box"></div></div>
        <div class="qst-check-cell"><div class="qst-box"></div></div>
        <div class="qst-check-cell"><div class="qst-box"></div></div>
      </div>`;
    }).join('');

    return `<div class="qst-famille">
      <div class="qst-famille-head" style="background:${fam.color}">${fam.label}</div>
      <div class="qst-col-header">
        <div class="qst-col-label">Je suis capable deâ€¦</div>
        <div class="qst-col-label">OUI</div>
        <div class="qst-col-label">NON</div>
        <div class="qst-col-label">UN PEU</div>
      </div>
      ${rows}
    </div>`;
  }).join('');

  document.getElementById('qst-output').innerHTML = `
  <div class="qst-header">
    <div>
      <div class="qst-title">Auto-Ã©valuation Â· Savoir Rouler Ã  VÃ©lo</div>
      <div class="qst-subtitle">${cycle.classe||'Classe'} Â· ${date}</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:10px;color:rgba(255,255,255,.5);margin-bottom:4px">PRÃ‰NOM</div>
      <input class="qst-prenom" placeholder="____________________" />
    </div>
  </div>
  ${body}`;
}

function printQuestionnaire() {
  renderQuestionnaire();
  // Ajouter la classe sur body pour activer les rÃ¨gles CSS print-qst
  document.body.classList.add('print-qst');
  window.print();
  // Retirer la classe aprÃ¨s l'impression
  setTimeout(() => document.body.classList.remove('print-qst'), 500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTOSAVE â€” localStorage
   Sauvegarde automatique Ã  chaque action significative
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LS_KEY_STATE = 'srav_state_v5';
const LS_KEY_CYCLE = 'srav_cycle_v5';
let _autosaveTimer = null;

function autosave() {
  // Indiquer "en cours"
  const dot = document.getElementById('autosave-dot');
  const msg = document.getElementById('autosave-msg');
  const bar = document.getElementById('autosave-bar');
  if(dot) dot.classList.add('saving');
  if(bar) bar.classList.remove('hidden');

  clearTimeout(_autosaveTimer);
  _autosaveTimer = setTimeout(() => {
    try {
      // Lire les Ã©ventuels textes non encore dÃ©clenchÃ©s
      syncBilanRapide();
      readStep1();
      localStorage.setItem(LS_KEY_STATE, JSON.stringify(state));
      localStorage.setItem(LS_KEY_CYCLE, JSON.stringify(cycle));
      const now = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
      if(dot) dot.classList.remove('saving');
      if(msg) msg.textContent = `Sauvegarde automatique â€” ${now}`;
    } catch(e) {
      // localStorage plein ou dÃ©sactivÃ© â€” on ignore silencieusement
      if(dot) dot.classList.remove('saving');
    }
  }, 800); // dÃ©lai pour grouper les appels rapides
}

function restaurerSession() {
  try {
    const savedState = localStorage.getItem(LS_KEY_STATE);
    const savedCycle = localStorage.getItem(LS_KEY_CYCLE);
    if(savedState) {
      const s = JSON.parse(savedState);
      // Restaurer state
      Object.assign(state, s);
      // Sync champs Ã©tape 1
      const fields = {
        'f-ecole': state.ecole, 'f-classe': state.classe,
        'f-effectif': state.effectif, 'f-lieu': state.lieu,
        'f-seance-num': state.seanceNum, 'f-seance-total': state.seanceTotal
      };
      Object.entries(fields).forEach(([id,val]) => {
        const el = document.getElementById(id);
        if(el) el.value = val;
      });
      renderGroupes();
    }
    if(savedCycle) {
      const c = JSON.parse(savedCycle);
      Object.assign(cycle, c);
    }
    document.getElementById('session-banner').style.display = 'none';
    showToast('âœ“ Session restaurÃ©e');
    autosave();
  } catch(e) {
    showToast('âš  Impossible de restaurer la session');
  }
}

function ignorerSession() {
  document.getElementById('session-banner').style.display = 'none';
  localStorage.removeItem(LS_KEY_STATE);
  localStorage.removeItem(LS_KEY_CYCLE);
}

function verifierSessionExistante() {
  try {
    const saved = localStorage.getItem(LS_KEY_STATE);
    if(!saved) return;
    const s = JSON.parse(saved);
    // Il y a quelque chose de non-vide : montrer la banniÃ¨re
    const hasData = s.ecole || s.classe || s.groupes?.some(g => g.situations?.length > 0);
    if(hasData) {
      document.getElementById('session-banner').style.display = 'flex';
    }
  } catch(e) { /* ignore */ }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RÃ‰INITIALISATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function confirmerReinit() {
  const modal = document.getElementById('reinit-modal');
  modal.style.display = 'flex';
}
function fermerReinit() {
  document.getElementById('reinit-modal').style.display = 'none';
}
function reinitialiser() {
  // Vider localStorage
  localStorage.removeItem(LS_KEY_STATE);
  localStorage.removeItem(LS_KEY_CYCLE);
  // Remettre l'Ã©tat Ã  zÃ©ro
  state = {
    ecole:"", classe:"", effectif:24, lieu:"", seanceNum:1, seanceTotal:10,
    groupes: []
  };
  cycle = { ecole:"", classe:"", seances:[] };
  // Sync UI Ã©tape 1
  ['f-ecole','f-classe','f-lieu'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('f-effectif').value = 24;
  document.getElementById('f-seance-num').value = 1;
  document.getElementById('f-seance-total').value = 10;
  renderGroupes();
  // Cacher la banniÃ¨re de session si visible
  const banner = document.getElementById('session-banner');
  if(banner) banner.style.display = 'none';
  // Cacher la barre autosave
  const bar = document.getElementById('autosave-bar');
  if(bar) bar.classList.add('hidden');
  // Fermer le modal et revenir Ã  l'Ã©tape 1
  fermerReinit();
  goStep(1);
  showToast('ğŸ—‘ Outil rÃ©initialisÃ© â€” nouvelle session prÃªte');
}

// Fermer le modal en cliquant Ã  l'extÃ©rieur
document.getElementById('reinit-modal').addEventListener('click', function(e) {
  if(e.target === this) fermerReinit();
});
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
renderGroupes();
document.getElementById('f-effectif').addEventListener('input', () => { updateEffectifCheck(); autosave(); });

// Autosave sur tous les champs Ã©tape 1
['f-ecole','f-classe','f-lieu','f-seance-num','f-seance-total'].forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', autosave);
});

// Drag-drop JSON sur l'Ã©cran suivi
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  if(document.getElementById('screen-suivi').classList.contains('active')) {
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if(file && file.name.endsWith('.json')) _readCycleFile(file);
  }
});

// VÃ©rifier si une session prÃ©cÃ©dente existe
verifierSessionExistante();
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GOATCOUNTER â€” Analytics RGPD-friendly
     Remplacez VOTRE-NOM par votre identifiant
     crÃ©Ã© sur goatcounter.com
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script data-goatcounter="https://VOTRE-NOM.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
